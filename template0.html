<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVRL Glass - Dynamic Client</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://kit.fontawesome.com/82efab1b7d.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: background 0.3s ease;
            height: 100%;
            min-height: 100%;
        }

        html.glass-mode {
            background: transparent !important;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            font-size: 12px;
            background: transparent;
            transition: background 0.3s ease;
        }

        #avrl-glass-container {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease;
        }

        body.glass-mode #avrl-glass-container,
        html.glass-mode #avrl-glass-container {
            background: transparent !important;
            /* Fully transparent */
            backdrop-filter: none !important;
            /* Remove blur so background is clear */
            -webkit-backdrop-filter: none !important;
            border-right: 1px solid rgba(4, 93, 105, 0.1) !important;
        }

        /* Glass mode - make text and elements subtle but visible */
        body.glass-mode,
        body.glass-mode *,
        html.glass-mode,
        html.glass-mode * {
            color: rgba(0, 0, 0, 0.3) !important;
            /* 70% transparent text - more visible */
        }

        /* Header - Frosted glass */
        #avrl-glass-header {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            color: #263238;
            padding: 6px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        body.glass-mode #avrl-glass-header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        #avrl-glass-header button {
            background: rgba(4, 93, 105, 0.15);
            color: #03363d;
            border: 1px solid rgba(4, 93, 105, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            cursor: pointer;
            padding: 4px 10px;
            font-weight: 600;
            border-radius: 6px;
            font-size: 11px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(4, 93, 105, 0.2);
        }

        body.glass-mode #avrl-glass-header button {
            background: rgba(4, 93, 105, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(4, 93, 105, 0.1);
        }

        #avrl-glass-header button:hover {
            background: rgbargba(4, 93, 105, 0.25);
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.3);
            transform: translateY(-1px);
        }

        /* Content */
        #avrl-glass-content {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Rate Display Section - Frosted glass */
        #rate-display {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            padding: 6px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-shrink: 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        /* Rate Row - Everything in horizontal row */
        .rate-row {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
            flex-direction: row;
            flex-wrap: wrap;
            min-width: 0; /* Allow flex items to shrink */
        }

        /* AVRL box - push elements to extreme opposite sides */
        .rate-box:first-of-type .rate-row {
            justify-content: space-between;
            width: 100%;
            gap: 10px;
        }

        .rate-box:first-of-type {
            position: relative;
            overflow: visible; /* Prevent clipping */
        }

        /* DAT box - space between label and rates, then rates distributed */
        .rate-box:last-of-type .rate-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 4px;
        }

        .rate-box:last-of-type .rate-row h4 {
            flex-shrink: 0;
            margin-right: 8px;
        }

        .rate-box:last-of-type .rate-row .rate-item {
            flex: 1;
            justify-content: center;
            min-width: fit-content; /* Prevent truncation */
        }

        /* Geo box - allow timeframe to wrap to next line */
        .geo-rate-row {
            flex-wrap: wrap !important;
            gap: 6px !important;
        }

        .geo-rate-row .dat-row,
        .geo-rate-row > div:not(.rate-item) {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .geo-rate-row .timeframe-item {
            flex: 0 1 auto; /* Allow to shrink/grow but don't force full width */
            min-width: fit-content; /* Ensure content isn't clipped */
            justify-content: flex-start;
        }

        /* AVRL main section - AVRL label and rate horizontally */
        .avrl-main-section {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            min-width: 0;
        }

        /* Base and Fuel stacked vertically */
        .base-fuel-stack {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: flex-end;
            flex-shrink: 0; /* Prevent shrinking */
            min-width: fit-content; /* Ensure content is not clipped */
        }

        .rate-subrow {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rate-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0; /* Prevent shrinking of rate items */
            min-width: fit-content; /* Ensure content is not clipped */
            white-space: nowrap; /* Keep labels and values on same line */
        }



        .rate-label {
            font-size: 8px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        body.glass-mode .rate-label {
            color: rgba(102, 102, 102, 0.3);
        }

        .rate-item strong {
            font-size: 10px;
            color: #263238;
            font-weight: 700;
        }

        body.glass-mode .rate-item strong {
            color: rgba(38, 50, 56, 0.3);
        }

        /* Rate Ratio Styling with Color Thresholds */
        .rate-ratio {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        /* Color thresholds for ratios */
        .rate-ratio.ratio-excellent {
            color: #155724;
            background-color: #d4edda;
        }

        .rate-ratio.ratio-good {
            color: #0c5460;
            background-color: #d1ecf1;
        }

        .rate-ratio.ratio-moderate {
            color: #856404;
            background-color: #fff3cd;
        }

        .rate-ratio.ratio-warning {
            color: #721c24;
            background-color: #f8d7da;
        }

        .rate-ratio.ratio-critical {
            color: #ffffff;
            background-color: #dc3545;
        }

        /* Glass mode adjustments */
        body.glass-mode .rate-ratio.ratio-excellent {
            color: rgba(21, 87, 36, 0.4);
            background-color: rgba(212, 237, 218, 0.2);
        }

        body.glass-mode .rate-ratio.ratio-good {
            color: rgba(12, 84, 96, 0.4);
            background-color: rgba(209, 236, 241, 0.2);
        }

        body.glass-mode .rate-ratio.ratio-moderate {
            color: rgba(133, 100, 4, 0.4);
            background-color: rgba(255, 243, 205, 0.2);
        }

        body.glass-mode .rate-ratio.ratio-warning {
            color: rgba(114, 28, 36, 0.4);
            background-color: rgba(248, 215, 218, 0.2);
        }

        body.glass-mode .rate-ratio.ratio-critical {
            color: rgba(255, 255, 255, 0.5);
            background-color: rgba(220, 53, 69, 0.3);
        }

        /* Rate Graph Container */
        .rate-graph-container {
            width: 100%;
            height: 75px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            padding: 0;
            margin-top: 8px;
            opacity: 0;
            transform: translateY(10px);
            overflow: visible;
        }

        /* Magnifying Glass Icon */
        .graph-zoom-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(4, 93, 105, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .graph-zoom-icon:hover {
            background: rgba(4, 93, 105, 0.1);
            border-color: #03363d;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(4, 93, 105, 0.3);
        }

        .graph-zoom-icon i {
            font-size: 12px;
            color: #03363d;
        }

        .rate-graph-container.show {
            display: flex;
            animation: slideInGraph 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideInGraph {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rate-graph-container:hover {
            transform: scale(1.03) translateY(-1px);
        }

        /* Rate box with graph - column layout */
        .rate-box-with-graph {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: auto;
            position: relative;
            overflow: visible;
        }

        /* Horizontal Range Bar - Chart Container */
        .range-bar {
            width: 100%;
            height: 48px;
            position: relative;
            overflow: visible;
            padding: 5px 0 20px 0;
            cursor: pointer;
        }

        .range-bar:hover {
            opacity: 0.95;
        }

        /* X-Axis Line */
        .x-axis {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 20px;
            height: 2px;
            background: linear-gradient(90deg,
                    #e0e0e0 0%,
                    #bdbdbd 100%);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .x-axis::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 4px 4px 4px 0;
            border-color: transparent #757575 transparent transparent;
        }

        .x-axis::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 4px 0 4px 4px;
            border-color: transparent transparent transparent #757575;
        }

        /* Axis Scale Labels */
        .axis-labels {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 18px;
            font-size: 9px;
            color: #757575;
            font-weight: 600;
        }

        .axis-label {
            position: absolute;
            bottom: 0;
            text-align: center;
            white-space: nowrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;

        }

        /* Stacked Bar Container */
        .stacked-bar-horizontal {
            position: absolute;
            left: 0;
            bottom: 28px;
            height: 16px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            box-shadow:
                0 3px 8px rgba(0, 0, 0, 0.15),
                0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bar-stack-segment {
            height: 100%;
            position: relative;
            background-image: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.25) 0%,
                    transparent 50%,
                    rgba(0, 0, 0, 0.15) 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
        }

        .bar-stack-segment:first-child {
            border-radius: 6px 0 0 6px;
        }

        .bar-stack-segment:last-child {
            border-radius: 0 6px 6px 0;
            border-right: none;
        }

        .bar-stack-segment:only-child {
            border-radius: 6px;
        }

        .bar-stack-segment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3), transparent);
            pointer-events: none;
        }

        /* Segment value labels on hover */
        .bar-stack-segment.show-value::after {
            content: attr(data-value);
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 700;
            color: #263238;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
        }

        .graph-modal-body .bar-stack-segment.show-value::after {
            opacity: 1;
            font-size: 10px;
            padding: 3px 8px;
        }

        /* Hover Line & Label */
        .graph-hover-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            border-left: 1px dashed #333;
            pointer-events: none;
            z-index: 10;
            display: none;
            opacity: 0.6;
        }

        .graph-hover-label {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            pointer-events: none;
            z-index: 11;
            display: none;
            white-space: nowrap;
            font-family: monospace;
        }

        /* DAT Rate Markers */
        .dat-marker {
            position: absolute;
            bottom: 22px;
            width: 1px;
            height: 26px;
            background: currentColor;
            transform: translateX(-50%);
            z-index: 5;
            opacity: 0.8;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .dat-marker::before {
            content: attr(data-label);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 700;
            color: currentColor;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.95);
            padding: 2px 5px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid currentColor;
        }

        .dat-marker::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: currentColor;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dat-marker.dat-low {
            color: #4caf50;
        }

        .dat-marker.dat-avg {
            color: #03363d;
        }

        .dat-marker.dat-high {
            color: #ff9800;
        }

        .dat-marker.avrl-marker {
            z-index: 10;
            opacity: 0.9;
        }

        /* Tooltip for graph */
        .graph-tooltip {
            position: absolute;
            background: linear-gradient(135deg, #263238 0%, #37474f 100%);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            box-shadow:
                0 6px 20px rgba(0, 0, 0, 0.4),
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .graph-tooltip::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 6px 6px 0;
            border-color: transparent #263238 transparent transparent;
        }

        .graph-tooltip.show {
            opacity: 1;
        }

        .graph-tooltip strong {
            display: block;
            margin-bottom: 4px;
            color: #64ffda;
            font-weight: 700;
            font-size: 12px;
        }

        /* Rate Card Flip Animation */
        .rate-card-wrapper {
            perspective: 1000px;
            position: relative;
        }

        .rate-card-flipper {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .rate-card-flipper.flipped {
            transform: rotateY(180deg);
        }

        .rate-card-front,
        .rate-card-back {
            backface-visibility: hidden;
        }

        .rate-card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .rate-card-back .stacked-bar {
            width: 80%;
            max-width: 200px;
        }

        /* Graph Modal */
        #rate-graph-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #rate-graph-modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .graph-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        body.glass-mode .graph-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .graph-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #03363d;
        }

        .graph-modal-header h3 {
            font-size: 20px;
            color: #03363d;
            margin: 0;
        }

        .graph-modal-close {
            cursor: pointer;
            font-size: 24px;
            color: #666;
            transition: color 0.2s;
        }

        .graph-modal-close:hover {
            color: #f44336;
        }

        .graph-modal-body {
            display: flex;
            gap: 30px;
            align-items: stretch;
            min-height: 300px;
        }

        .graph-modal-body .range-bar {
            position: relative;
            margin-top: 40px;
            height: 120px;
            padding: 10px 0 30px 0;
        }

        .graph-modal-body .stacked-bar-horizontal {
            height: 35px;
            bottom: 35px;
            border-radius: 8px;
        }

        .graph-modal-body .dat-marker {
            height: 50px;
            bottom: 28px;
            width: 2px;
        }

        .graph-modal-body .dat-marker::before {
            font-size: 11px;
            padding: 4px 8px;
        }

        .graph-modal-body .dat-marker::after {
            width: 8px;
            height: 8px;
        }

        .graph-modal-body .x-axis {
            height: 3px;
        }

        .graph-modal-body .axis-labels {
            font-size: 11px;
            font-weight: 700;
        }

        .graph-modal-body .bar-stack-segment {
            border-right: 2px solid rgba(255, 255, 255, 0.5);
        }

        .graph-legend {
            flex: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(4, 93, 105, 0.05);
            border-radius: 6px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-info {
            flex: 1;
        }

        .legend-info strong {
            display: block;
            font-size: 14px;
            color: #263238;
            margin-bottom: 2px;
        }

        .legend-info span {
            font-size: 12px;
            color: #666;
        }

        /* Bid Failure Message */
        #bid-failure-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 6px;
            padding: 8px;
            color: #d32f2f;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }

        body.glass-mode #bid-failure-message {
            background: rgba(244, 67, 54, 0.05);
            border-color: rgba(244, 67, 54, 0.15);
            color: rgba(211, 47, 47, 0.3);
        }

        .rate-box {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            padding: 6px 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: visible; /* Changed from hidden to visible */
            min-width: 0; /* Allow shrinking */
            word-wrap: break-word; /* Break long words if needed */
        }

        .rate-box h4 {
            font-size: 9px;
            color: #03363d;
            margin: 0;

            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .rate-main {
            font-size: 15px;
            font-weight: 700;
            color: #263238;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0px 4px;
            border-radius: 3px;
            user-select: none;
        }

        .rate-main:hover {
            background: rgba(4, 93, 105, 0.1);
            color: #03363d;
            transform: scale(1.02);
        }

        .rate-main:active {
            transform: scale(0.98);
        }

        .rate-main.copied {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        #rate-info-icon {
            font-size: 11px;
            color: #03363d;
            cursor: pointer;
            transition: color 0.2s ease;
            flex-shrink: 0;
        }

        #rate-info-icon:hover {
            color: #045d69;
        }

        body.glass-mode #rate-info-icon {
            color: rgba(4, 93, 105, 0.5);
        }

        /* Rate Breakdown Tooltip */
        .rate-tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 8px;
            border: 2px solid #03363d;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            overflow: hidden;
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .rate-tooltip-header {
            padding: 12px 16px;
            background: linear-gradient(135deg, #045d69 0%, #03363d 100%);
            color: white;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rate-tooltip-content {
            padding: 16px;
            overflow-y: auto;
            max-height: 440px;
        }

        body.glass-mode .rate-tooltip {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 2px solid rgba(4, 93, 105, 0.3);
        }

        body.glass-mode .rate-tooltip-header {
            background: rgba(4, 93, 105, 0.1);
            color: rgba(0, 0, 0, 0.1);
        }

        body.glass-mode .rate-tooltip-content {
            color: rgba(38, 50, 56, 0.1);
        }

        #rate-reasons-list {
            margin: 0;
            padding-left: 20px;
        }

        #rate-reasons-list li {
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.5;
            color: #263238;
        }

        body.glass-mode #rate-reasons-list li {
            color: rgba(38, 50, 56, 0.1);
        }

        body.glass-mode .rate-tooltip-header strong {
            color: rgba(0, 0, 0, 0.1);
        }



        body.glass-mode #rate-display {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        body.glass-mode .rate-box {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        body.glass-mode .rate-box h4 {
            color: rgba(4, 93, 105, 0.3);
        }

        body.glass-mode .rate-main {
            color: rgba(0, 0, 0, 0.3);
        }

        body.glass-mode .rate-main:hover {
            background: rgba(4, 93, 105, 0.05);
            color: rgba(4, 93, 105, 0.3);
        }

        body.glass-mode .rate-main.copied {
            background: rgba(76, 175, 80, 0.1);
            color: rgba(76, 175, 80, 0.3);
        }

        /* Form Container */
        #form-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Stop Item - Frosted glass */
        .stop-item {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            padding: 6px;
            height: 75px;
            margin-bottom: 6px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .stop-item:hover {
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.15);
            border-color: rgba(4, 93, 105, 0.3);
        }

        body.glass-mode .stop-item {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(255, 255, 255, 0.05);
        }

        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .stop-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #666;
            transition: color 0.3s ease;
        }

        body.glass-mode .stop-label {
            color: rgba(51, 51, 51, 0.1);
        }

        .stop-label.required:after {
            content: " *";
            color: red;
        }

        .stop-controls {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        /* Live/Drop Toggle */
        .toggle-switch {
            display: none;
        }

        .toggle-label {
            position: relative;
            display: inline-flex;
            background: rgba(4, 93, 105, 0.15);
            border-radius: 12px;
            padding: 2px;
            cursor: pointer;
            border: 2px solid rgba(4, 93, 105, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(4, 93, 105, 0.2);
        }

        body.glass-mode .toggle-label {
            background: rgba(4, 93, 105, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(4, 93, 105, 0.1);
        }

        .toggle-label span {
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 600;
            z-index: 1;
            transition: color 0.3s;
        }

        .toggle-label::before {
            content: '';
            position: absolute;
            width: calc(50% - 2px);
            height: calc(100% - 4px);
            background: white;
            border-radius: 10px;
            left: 2px;
            top: 2px;
            transition: transform 0.3s, background 0.3s;
        }

        body.glass-mode .toggle-label::before {
            background: rgba(255, 255, 255, 0.1);
        }

        .toggle-switch:checked+.toggle-label::before {
            transform: translateX(100%);
        }

        .toggle-switch+.toggle-label span:first-child {
            color: #03363d;
        }

        body.glass-mode .toggle-switch+.toggle-label span:first-child {
            color: rgba(4, 93, 105, 0.3);
        }

        .toggle-switch+.toggle-label span:last-child {
            color: #03363d;
        }

        body.glass-mode .toggle-switch+.toggle-label span:last-child {
            color: rgba(4, 93, 105, 0.3);
        }

        .toggle-switch:checked+.toggle-label span:first-child {
            color: #03363d;
        }

        body.glass-mode .toggle-switch:checked+.toggle-label span:first-child {
            color: rgba(4, 93, 105, 0.3);
        }

        .toggle-switch:checked+.toggle-label span:last-child {
            color: #03363d;
        }

        body.glass-mode .toggle-switch:checked+.toggle-label span:last-child {
            color: rgba(4, 93, 105, 0.3);
        }

        .delete-stop {
            font-size: 12px;
            color: #999;
            cursor: pointer;
            padding: 2px 4px;
            transition: all 0.2s ease;
        }

        .delete-stop:hover {
            color: #f44336;
            transform: scale(1.1);
        }

        /* Stops Container Wrapper */
        #stops-container {
            margin-bottom: 6px;
            position: relative;
        }

        /* Stops Grid - 2 Column Layout for Side-by-Side Stops */
        #stops-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
        }

        /* Stop ZIP Container - Vertical Layout */
        .stop-zip-container {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }

        /* ZIP input field */
        .stop-zip-field {
            position: relative;
            margin-bottom: 0;
            width: 40%;
        }

        .stop-zip-field input {
            font-size: 11px;
        }

        /* Location Text Display Below ZIP */
        .stop-location-text {
            font-size: 10px;
            color: #666;
            padding: 2px 4px;
            width: 90%;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 16px;
        }

        body.glass-mode .stop-location-text {
            color: rgba(102, 102, 102, 0.3);
        }

        .stop-location-text.placeholder {
            font-style: italic;
            opacity: 0.6;
        }

        body.glass-mode .stop-location-text.placeholder {
            opacity: 0.4;
        }

        /* Edit icon next to location text */
        .stop-location-edit-icon {
            cursor: pointer;
            color: #03363d;
            font-size: 10px;
            padding-left: 10px;
            transition: all 0.2s;
            margin-left: auto;
        }

        .stop-location-edit-icon:hover {
            color: #045d69;
            transform: scale(1.15);
        }

        body.glass-mode .stop-location-edit-icon {
            color: rgba(4, 93, 105, 0.3);
        }

        /* Add Stop Button - Centered Between Columns */
        #add-stop-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: 1px solid rgba(4, 93, 105, 0.4);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: #03363d;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 6px rgba(4, 93, 105, 0.15);
            z-index: 10;
        }

        body.glass-mode #add-stop-btn {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(4, 93, 105, 0.2);
        }

        #add-stop-btn:hover {
            border-color: #03363d;
            color: white;
            background: linear-gradient(135deg, #03363d 0%, #0288d1 100%);
            border-width: 2px;
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.4);
            transform: translate(-50%, -50%) scale(1.2);
        }

        body.glass-mode #add-stop-btn:hover {
            background: rgba(4, 93, 105, 0.3);
        }

        #add-stop-btn i {
            font-size: 9px;
        }

        /* Remove old unused styles */
        .stop-zip-icon,
        .stop-edit-icon {
            display: none;
        }

        .stop-location-summary {
            display: none;
        }

        /* OLD Location Tag - kept for backward compatibility but not used */
        /* Location Tag (Editable P) - Frosted glass */
        .location-tag {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #263238;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        body.glass-mode .location-tag {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(4, 93, 105, 0.1);
            color: rgba(0, 0, 0, 0.3);
        }

        .location-tag:hover {
            background: rgba(4, 93, 105, 0.1);
            border-color: #03363d;
            box-shadow: 0 4px 8px rgba(4, 93, 105, 0.15);
            transform: translateY(-1px);
        }

        body.glass-mode .location-tag:hover {
            background: rgba(4, 93, 105, 0.05);
            border-color: rgba(4, 93, 105, 0.1);
        }

        .location-tag i {
            font-size: 9px;
            color: #03363d;
        }

        body.glass-mode .location-tag i {
            color: rgba(4, 93, 105, 0.3);
        }


        /* Input Row - 2 Column Layout */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
        }

        .input-field {
            position: relative;
            margin-bottom: 6px;
        }

        .input-field input,
        .input-field select {
            width: 100%;
            padding: 8px 6px;
            font-size: 11px;
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            outline: none;
            font-family: 'Montserrat', sans-serif;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: #263238;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
        }

        body.glass-mode .input-field input,
        body.glass-mode .input-field select {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(4, 93, 105, 0.1);
            color: rgba(0, 0, 0, 0.3);
        }

        .input-field input:focus,
        .input-field select:focus {
            border-color: #03363d;
            box-shadow: 0 0 0 3px rgba(4, 93, 105, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        body.glass-mode .input-field input:focus,
        body.glass-mode .input-field select:focus {
            border-color: rgba(4, 93, 105, 0.2);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* Walkthrough Mode Highlight */
        .walkthrough-highlight {
            border: 2px solid #ff9800 !important;
            box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.3) !important;
            background: rgba(255, 152, 0, 0.05) !important;
            animation: walkthrough-pulse 1.5s ease-in-out infinite;
        }

        @keyframes walkthrough-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 4px rgba(255, 152, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(255, 152, 0, 0.2);
            }
        }

        .walkthrough-badge {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(255, 152, 0, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            text-align: left;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }

        .walkthrough-badge .walkthrough-instructions {
            margin-top: 6px;
            font-size: 11px;
            font-weight: 400;
            opacity: 0.9;
            line-height: 1.4;
        }

        .walkthrough-badge kbd {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }

        /* Searchable Select Styles */
        .searchable-select-container {
            position: relative;
            width: 100%;
        }

        .searchable-select-input {
            width: 100%;
            padding: 8px 6px;
            font-size: 11px;
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .searchable-select-input:focus {
            outline: none;
            border-color: #03363d;
            box-shadow: 0 0 0 3px rgba(4, 93, 105, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        body.glass-mode .searchable-select-input {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(4, 93, 105, 0.1);
            color: rgba(0, 0, 0, 0.3);
        }

        body.glass-mode .searchable-select-input:focus {
            border-color: rgba(4, 93, 105, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 280px;
            overflow-y: auto;
            overflow-x: hidden;
            background: white;
            border: 1px solid rgba(4, 93, 105, 0.3);
            border-radius: 6px;
            margin-top: 4px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            scrollbar-width: thin;
        }

        .searchable-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .searchable-select-dropdown::-webkit-scrollbar-track {
            background: transparent;
        }

        .searchable-select-dropdown::-webkit-scrollbar-thumb {
            background-color: rgba(4, 93, 105, 0.3);
            border-radius: 3px;
        }

        .searchable-select-dropdown::-webkit-scrollbar-thumb:hover {
            background-color: rgba(4, 93, 105, 0.5);
        }

        body.glass-mode .searchable-select-dropdown {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-color: rgba(4, 93, 105, 0.2);
        }

        .searchable-select-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s ease;
            border-bottom: 1px solid rgba(4, 93, 105, 0.1);
            background: white;
            min-height: 36px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.glass-mode .searchable-select-option {
            background: transparent;
        }

        .searchable-select-option:last-child {
            border-bottom: none;
        }

        .searchable-select-option:hover {
            background: rgba(4, 93, 105, 0.1);
        }

        body.glass-mode .searchable-select-option:hover {
            background: rgba(4, 93, 105, 0.05);
        }

        .searchable-select-option input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            accent-color: #03363d;
        }

        .searchable-select-option>span {
            flex: 1;
            user-select: none;
            line-height: 1.4;
            font-size: 12px;
            color: #333;
        }

        body.glass-mode .searchable-select-option>span {
            color: rgba(0, 0, 0, 0.8);
        }

        /* Style for multiselect container */
        .searchable-select-container.multiselect .searchable-select-input {
            cursor: text;
        }

        .searchable-select-container.multiselect .searchable-select-input:read-only {
            cursor: pointer;
        }

        /* Better styling for checked items in multiselect */
        .searchable-select-option input[type="checkbox"]:checked+span {
            font-weight: 600;
            color: #03363d;
        }

        body.glass-mode .searchable-select-option input[type="checkbox"]:checked+span {
            color: rgba(4, 93, 105, 0.9);
            font-weight: 600;
        }

        .searchable-select-dropdown.hide {
            display: none;
        }

        /* Make searchable select work with floating labels */
        /* Default position - label inside field - FORCE this unless specifically overridden */
        .input-field .searchable-select-container+label {
            position: absolute !important;
            left: 7px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            font-size: 11px !important;
            color: #999 !important;
            background: transparent !important;
            padding: 0 4px !important;
            pointer-events: none;
            transition: all 0.2s ease;
            font-weight: 400 !important;
            text-transform: none !important;
            letter-spacing: normal !important;
        }
        
        /* Float label when focused or has value - override with higher specificity */
        .input-field .searchable-select-container:focus-within+label,
        .input-field.has-value .searchable-select-container+label {
            top: 0 !important;
            transform: translateY(-50%) !important;
            font-size: 9px !important;
            color: #343434 !important;
            background: white !important;
            padding: 0 4px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.3px !important;
        }

        body.glass-mode .input-field .searchable-select-container+label {
            color: rgba(0, 0, 0, 0.1) !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }

        body.glass-mode .input-field .searchable-select-container:focus-within+label,
        body.glass-mode .input-field.has-value .searchable-select-container+label {
            background: rgba(255, 255, 255, 0.1) !important;
            color: rgba(52, 52, 52, 0.4) !important;
        }


        .input-field label {
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #999;
            background: transparent;
            padding: 0 4px;
            pointer-events: none;
            transition: all 0.2s ease;
            font-weight: 400;
        }

        body.glass-mode .input-field label {
            color: rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.1);
        }

        body.glass-mode .input-field input:is(:focus, :not(:placeholder-shown))+label,
        body.glass-mode .input-field.has-value label {
            background: rgba(255, 255, 255, 0.1);
        }

        .input-field label.required:after {
            content: " *";
            color: red;
        }

        /* Inline field error message */
        .field-error {
            display: none;
            font-size: 10px;
            color: #d32f2f;
            margin-top: 4px;
            padding: 6px 8px;
            background: rgba(244, 67, 54, 0.08);
            border-radius: 4px;
            border-left: 3px solid #d32f2f;
            line-height: 1.4;
        }

        .field-error.show {
            display: block;
            animation: fieldErrorSlide 0.2s ease-out;
        }

        @keyframes fieldErrorSlide {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .field-error strong {
            display: block;
            margin-bottom: 2px;
        }

        .field-error ul {
            margin: 4px 0 0 0;
            padding-left: 16px;
        }

        .field-error li {
            margin: 2px 0;
        }

        .input-field.has-error input {
            border-color: #d32f2f !important;
            background: rgba(244, 67, 54, 0.03);
        }

        body.glass-mode .field-error {
            background: rgba(244, 67, 54, 0.05);
            color: rgba(211, 47, 47, 0.7);
        }

        /* When focused or has content - float to border */
        .input-field input:is(:focus, :not(:placeholder-shown))+label,
        .input-field.has-value label,
        .input-field select:focus+label,
        .input-field select:valid+label {
            top: 0;
            transform: translateY(-50%);
            font-size: 9px;
            color: #343434;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: white;
        }

        /* Keep placeholder transparent */
        .input-field input::placeholder {
            color: transparent;
        }

        .input-field input:focus::placeholder {
            color: #ccc;
        }

        /* Input with icon */
        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-right: 28px;
        }

        .input-with-icon .input-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 12px;
            transition: color 0.2s;
            z-index: 1;
        }

        body.glass-mode .input-with-icon .input-icon {
            color: rgba(0, 0, 0, 0.1);
        }

        .input-with-icon .input-icon:hover {
            color: #343434;
        }

        body.glass-mode .input-with-icon .input-icon:hover {
            color: rgba(0, 0, 0, 0.2);
        }

        /* Datetime parse icon specific styling */
        .datetime-parse-icon {
            color: #03363d !important;
            font-size: 13px !important;
            animation: subtleGlow 2s ease-in-out infinite;
        }

        @keyframes subtleGlow {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        .datetime-parse-icon:hover {
            color: #0097a7 !important;
            transform: translateY(-50%) scale(1.15);
        }

        body.glass-mode .datetime-parse-icon {
            color: rgba(4, 93, 105, 0.3) !important;
        }

        body.glass-mode .datetime-parse-icon:hover {
            color: rgba(4, 93, 105, 0.5) !important;
        }

        .input-with-icon label {
            position: absolute;
            left: 7px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #999;
            background: transparent;
            padding: 0 4px;
            pointer-events: none;
            transition: all 0.2s ease;
            font-weight: 400;
        }

        .input-with-icon input:is(:focus, :not(:placeholder-shown))+label,
        .input-field.has-value .input-with-icon label {
            top: 0;
            transform: translateY(-50%);
            font-size: 9px;
            color: #343434;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: white;
        }

        /* Action Buttons */
        #form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
            flex-shrink: 0;
        }

        #form-actions button {
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.glass-mode #form-actions button {
            background: rgba(4, 93, 105, 0.05) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border: 1px solid rgba(4, 93, 105, 0.1) !important;
        }

        /* #form-actions button:first-child {
            background: linear-gradient(135deg, #03363d 0%, #0288d1 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.3);
        }

        #form-actions button:first-child:hover {
            background: linear-gradient(135deg, #00acc1 0%, #0277bd 100%);
            box-shadow: 0 6px 16px rgba(4, 93, 105, 0.4);
            transform: translateY(-1px);
        } */


        #form-actions button:first-child {
            background: linear-gradient(135deg, #045d69 0%, #03363d 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.3);
        }

        #form-actions button:first-child:hover {
            background: linear-gradient(135deg, #045d69 0%, #03363d 100%);
            box-shadow: 0 6px 16px rgba(4, 93, 105, 0.4);
            transform: translateY(-1px);
        }

        body.glass-mode #form-actions button:first-child:hover {
            background: rgba(4, 93, 105, 0.05) !important;
        }

        #form-actions button:last-child {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: #263238;
            border: 1px solid rgba(4, 93, 105, 0.2);
        }

        #form-actions button:last-child:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: #03363d;
            transform: translateY(-1px);
        }

        body.glass-mode #form-actions button:last-child:hover {
            background: rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        #location-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        body.glass-mode #location-modal {
            background: rgba(0, 0, 0, 0.1);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            width: 90%;
            max-width: 300px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        body.glass-mode .modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(4, 93, 105, 0.2);
        }

        .modal-header h3 {
            font-size: 13px;
            color: #03363d;
            font-weight: 600;
        }

        .modal-header i {
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 12px;
        }

        .modal-body .input-field {
            margin-bottom: 10px;
        }

        /* Show More Section */
        #modal-extra-fields {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }

        #show-more-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px;
            margin: 8px 0;
            font-size: 11px;
            color: #03363d;
            background: rgba(4, 93, 105, 0.08);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            transition: all 0.2s;
            user-select: none;
        }

        body.glass-mode #show-more-toggle {
            background: rgba(4, 93, 105, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            color: rgba(4, 93, 105, 0.3);
            border-color: rgba(4, 93, 105, 0.1);
        }

        #show-more-toggle:hover {
            background: rgba(4, 93, 105, 0.15);
            color: #0288d1;
            border-color: #03363d;
        }

        body.glass-mode #show-more-toggle:hover {
            background: rgba(4, 93, 105, 0.05);
            color: rgba(4, 93, 105, 0.3);
        }

        #show-more-toggle i {
            font-size: 10px;
            transition: transform 0.2s;
        }

        #show-more-toggle.expanded i {
            transform: rotate(180deg);
        }

        /* Form Show More Toggle */
        #form-show-more-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px;
            margin: 8px 0;
            font-size: 11px;
            color: #03363d;
            background: rgba(4, 93, 105, 0.08);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            transition: all 0.2s;
            user-select: none;
        }

        body.glass-mode #form-show-more-toggle {
            background: rgba(4, 93, 105, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            color: rgba(4, 93, 105, 0.3);
            border-color: rgba(4, 93, 105, 0.1);
        }

        #form-show-more-toggle:hover {
            background: rgba(4, 93, 105, 0.15);
            color: #045d69;
            border-color: #03363d;
        }

        body.glass-mode #form-show-more-toggle:hover {
            background: rgba(4, 93, 105, 0.05);
            color: rgba(4, 93, 105, 0.3);
        }

        #form-show-more-toggle i {
            font-size: 10px;
            transition: transform 0.2s;
        }

        #form-show-more-toggle.expanded i {
            transform: rotate(180deg);
        }

        #form-extra-fields {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
        }

        .modal-footer button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-footer button:first-child {
            background: linear-gradient(135deg, #03363d 0%, #01314d 100%);
            color: white;
        }

        .modal-footer button:first-child:hover {
            background: linear-gradient(135deg, #045d69 0%, #01314d 100%);
            transform: translateY(-1px);
        }

        body.glass-mode .modal-footer button:first-child {
            background: rgba(4, 93, 105, 0.1);
        }

        .modal-footer button:last-child {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: #263238;
            border: 1px solid rgba(4, 93, 105, 0.2);
        }

        .modal-footer button:last-child:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        body.glass-mode .modal-footer button:last-child {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* ZIP Fetch Icon */
        .zip-fetch-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #343434;
            cursor: pointer;
            background: white;
            padding: 2px;
        }

        .zip-fetch-icon:hover {
            color: #045d69;
        }

        /* Loading */
        #loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top: 5px solid #03363d;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .hide {
            display: none !important;
        }

        /* Custom Scrollbar */
        #avrl-glass-content::-webkit-scrollbar,
        #form-container::-webkit-scrollbar {
            width: 4px;
        }

        #avrl-glass-content::-webkit-scrollbar-track,
        #form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        #avrl-glass-content::-webkit-scrollbar-thumb,
        #form-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }

        /* Remove number spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Account selector */
        #account-selector-container {
            margin-bottom: 8px;
            flex-shrink: 0;
        }

        #account-selector-container select {
            width: 100%;
            padding: 6px;
            font-size: 11px;
            border: 1px solid rgba(4, 93, 105, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            color: #263238;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        #account-selector-container select:hover {
            border-color: #03363d;
            box-shadow: 0 0 0 3px rgba(4, 93, 105, 0.1);
        }

        /* Keyboard Shortcuts Info - Glass badge */
        .shortcuts-info {
            position: fixed;
            bottom: 8px;
            right: 8px;
            background: rgba(4, 93, 105, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: #03363d;
            padding: 3px 6px;
            border-radius: 12px;
            border: 1px solid rgba(4, 93, 105, 0.3);
            font-size: 10px;
            z-index: 1000;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(4, 93, 105, 0.2);
            transition: all 0.2s;
        }

        .shortcuts-info:hover {
            background: rgba(4, 93, 105, 0.25);
            padding: 6px 10px;
            box-shadow: 0 6px 16px rgba(4, 93, 105, 0.3);
        }

        .shortcuts-info i {
            font-size: 12px;
            margin-right: 4px;
        }

        .shortcuts-info .shortcut-details {
            display: none;
            flex-direction: column;
            gap: 3px;
            margin-left: 4px;
        }

        .shortcuts-info:hover .shortcut-details {
            display: flex;
        }

        .shortcuts-info .shortcut-row {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .shortcuts-info kbd {
            background: rgba(4, 93, 105, 0.2);
            padding: 1px 3px;
            border-radius: 3px;
            font-size: 9px;
            font-family: monospace;
            border: 1px solid rgba(4, 93, 105, 0.3);
            color: #0288d1;
            font-weight: 600;
        }

        .shortcuts-info .shortcut-desc {
            font-size: 9px;
            opacity: 0.95;
            color: #263238;
        }

        .shortcuts-info {
            display: none;
        }

        #rate-graph-mini {
            position: relative;
            height: 75px;
            align-items: flex-end;
            margin-bottom: 14px;
            display: none;
        }

        .axis-labels {
            position: relative;
            margin-top: 2px;
        }

        .axis-label {
            position: absolute;
            font-size: 10px;
            color: #555;
            transform: rotate(30deg) !important;
            bottom: -10px !important;
        }

        .dat-marker-line {
            pointer-events: none;
        }


        #rate-info-tooltip {
            position: absolute;
            display: none;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            font-family: "Inter", sans-serif;
            font-size: 11px;
            color: #333;
            z-index: 2147483638;
            min-width: 180px;
            /*  small tooltips stay compact */
            max-width: 300px;
            /*  but still bounded */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out;
            word-break: break-word;
            white-space: normal;
            line-height: 1.4;
            border-top: 3px solid #03363d;
            overflow: hidden;
        }

        /* Numeric cells use monospace font for alignment */
        #rate-info-tooltip td.rate-num {
            font-family: "Consolas", "Menlo", "Courier New", monospace;
            letter-spacing: 0.3px;
        }





        #rate-info-tooltip.show {
            display: block;
            opacity: 1;
            transform: translateY(2px);
        }

        .rate-info-header {
            background: #03363d;
            color: #fff;
            padding: 5px 8px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 11.5px;
        }

        .rate-info-content {
            padding: 6px 8px;
            line-height: 1.3;
        }

        .rate-info-content table {
            width: 100%;
            border-collapse: collapse;
        }

        .rate-info-content td {
            padding: 2px 3px;
            word-break: break-word;
            font-size: 10.5px;
        }

        .rate-info-content .total {
            color: #4caf50;
            font-weight: 600;
        }

        .num {
            font-family: monospace;
        }

        strong {
            font-family: monospace;
        }

        .slider-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
            padding: 18px 20px;
            /* max-width: 700px; */
            width: 100%;
            display: none;
            flex-direction: column;
            gap: 14px;
            /*  reduced spacing between sliders */
        }

        .slider-row {
            display: grid;
            grid-template-columns: 260px 1fr;
            align-items: center;
            gap: 18px;
            padding-bottom: 0px;
            /*  reduced bottom padding */
            border-bottom: 1px dashed rgba(0, 0, 0, 0.08);
        }

        .slider-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
            align-items: flex-start;
        }

        .slider-info label {
            font-weight: 600;
            font-size: 14px;
            color: #111;
            white-space: nowrap;
            line-height: 1.3;
        }

        .calc-text {
            font-family: "Roboto Mono", monospace;
            font-size: 11px;
            color: #666;
            cursor: pointer;
            transition: color 0.2s ease, background 0.3s ease;
            display: inline-block;
            padding: 2px 6px 2px 0;
            border-radius: 4px;
            user-select: none;
            white-space: nowrap;
            letter-spacing: -0.2px;
            line-height: 1.3;
        }

        .calc-text:hover {
            background: rgba(4, 93, 105, 0.08);
        }

        .editable-percent {
            color: #045d69;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
        }

        .slider-control {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            height: 52px;
            padding: 8px 16px 16px 16px;
            /* Top, horizontal, and bottom padding for labels */
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            appearance: none;
            background: rgba(4, 93, 105, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            position: relative;
            top: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 18px;
            background: #03363d;
            border-radius: 4px;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #0097a7;
            transform: scale(1.08);
        }

        .slider-ticks {
            position: absolute;
            top: 8px;
            left: 16px;
            right: 16px;
            height: 44px;
            pointer-events: none;
        }

        .tick {
            position: absolute;
            transform: translateX(-50%);
            top: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tick-line {
            width: 1px;
            height: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 1px;
        }

        .tick-label {
            margin-top: 4px;
            font-family: "Roboto Mono", monospace;
            font-size: 9px;
            color: #777;
            user-select: none;
            font-weight: 500;
        }

        .active input[type="range"]::-webkit-slider-thumb {
            background: #0073e6;
        }

        .active label {
            color: #0073e6;
        }

        .calc-text.copied {
            background: #e0ffe0;
            color: #2e7d32;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 20px 25px;
            border-radius: 10px;
            min-width: 320px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            font-family: "Inter", sans-serif;
        }

        .modal-content h4 {
            margin-top: 0;
            color: #222;
        }

        .modal-content input {
            width: 100%;
            padding: 8px;
            font-size: 15px;
            margin: 10px 0 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: "Roboto Mono", monospace;
        }

        .validation-msg {
            font-size: 12.8px;
            color: #c62828;
            min-height: 1em;
            margin-bottom: 10px;
            visibility: hidden;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        #cancelBtn {
            background: #ccc;
        }

        #applyBtn {
            background: #03363d;
            color: white;
        }

        /* ===== Responsive scaling for small widths ===== */
        @media (max-width: 500px) {
            body {
                padding: 10px;
            }

            .slider-card {
                padding: 10px;
                gap: 10px;
            }

            .slider-row {
                gap: 8px;
                padding-bottom: 0px;
            }

            .slider-info label {
                font-size: 11px;
            }

            .calc-text {
                font-size: 10px;
            }

            .slider-control {
                height: 48px;
                padding: 6px 12px 14px 12px;
            }

            .slider-ticks {
                top: 6px;
                left: 12px;
                right: 12px;
            }

            input[type="range"] {
                height: 4px;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 12px;
                height: 16px;
            }

            .tick-line {
                height: 6px;
            }

            .tick-label {
                font-size: 8px;
            }
        }

        /* Stack sliders vertically when Chrome extension panel is narrow */
        @media (max-width: 450px) {
            .slider-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        @media (max-width: 320px) {
            .slider-card {
                padding: 8px;
                gap: 8px;
            }

            .slider-row {
                grid-template-columns: 1fr;
            }

            .slider-info label {
                font-size: 10px;
            }

            .calc-text {
                font-size: 9px;
            }

            .slider-control {
                height: 44px;
                padding: 6px 10px 12px 10px;
            }

            .slider-ticks {
                top: 6px;
                left: 10px;
                right: 10px;
            }

            input[type="range"] {
                height: 3px;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 10px;
                height: 14px;
            }

            .tick-line {
                height: 5px;
            }

            .tick-label {
                font-size: 7px;
            }

            .tick-line {
                height: 10px;
            }

            .tick-label {
                font-size: 8px;
            }
        }

        /* Responsive CSS for rate boxes when UI is squeezed */
        @media (max-width: 400px) {
            .rate-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .rate-box:first-of-type .rate-row {
                flex-direction: column;
                align-items: stretch;
            }

            .avrl-main-section {
                width: 100%;
                justify-content: space-between;
            }

            .base-fuel-stack {
                width: 100%;
                align-items: flex-start;
            }

            .rate-box:last-of-type .rate-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .rate-box:last-of-type .rate-row h4 {
                margin-bottom: 4px;
            }

            .rate-graph-container {
                height: 60px;
            }

            .geo-rate-row .dat-row,
            .geo-rate-row > div:not(.rate-item) {
                width: 100%;
            }
        }


        input[type="range"] {
            width: 100%;
            height: 4px;
            appearance: none;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            background: #e5e7eb;
            /* very light grey for inactive sliders */
            position: relative;
            top: 8px;
            transition: background 0.3s ease;
        }

        /* active (highlighted) row gets bright color */
        .slider-row.active input[type="range"] {
            background: rgba(4, 93, 105, 0.35);
            /* same as active accent */
        }

        /* thumb style */
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 20px;
            background: white;
            /* default blue thumb */
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #03363d;
            transform: scale(1.05);
        }

        /* inactive slider thumb (greyed out) */
        .slider-row:not(.active) input[type="range"]::-webkit-slider-thumb {
            background: #045d69;
        }

        #resetSliders {
            color: #03363d;
            position: absolute;
            right: 24px;
            cursor: pointer !important;
            height: 10px;
            width: 10px;
            z-index: 10;
        }


        .slider-control {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            height: 56px;
            margin-top: 2px;
        }

        /* Base track */
        input[type="range"] {
            width: 100%;
            height: 8px;
            appearance: none;
            border-radius: 6px;
            outline: none;
            cursor: pointer;
            background: linear-gradient(90deg, #045d69, #03363d);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease;
        }

        /* When active (highlighted row) */
        .slider-row.active input[type="range"] {
            background: linear-gradient(90deg, #03363d 0%, #045d69 100%);
        }

        /* Circular Thumb */
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #03363d;
            border: 2px solid #fff;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 14px rgba(4, 93, 105, 0.4);
            border-color: #0097a7;
        }

        /* Inactive rows thumb */
        .slider-row:not(.active) input[type="range"]::-webkit-slider-thumb {
            background: #f1f1f1;
            border: 2px solid #ccc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* ------------------- Tick Marks ------------------- */
        .slider-ticks {
            position: absolute;
            top: 22px;
            left: 0;
            right: 0;
            height: 28px;
            pointer-events: none;
        }

        .tick {
            position: absolute;
            transform: translateX(-50%);
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tick-line {
            width: 2px;
            height: 6px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 2px;
        }

        .tick-label {
            margin-top: 4px;
            font-family: "Roboto Mono", monospace;
            font-size: 10px;
            color: #444;
            user-select: none;
        }

        /* Active row highlight */
        .slider-row.active label {
            color: #03363d;
        }

        /* Hover glow */
        .slider-row.active input[type="range"]:hover {
            box-shadow: 0 0 8px rgba(4, 93, 105, 0.25);
        }

        /* Reset icon hover */
        #resetSliders:hover {
            color: #0097a7;
            transform: scale(1.2);
            transition: transform 0.2s ease, color 0.2s ease;
        }

        /* Slight glow effect on active thumb */
        .slider-row.active input[type="range"]::-webkit-slider-thumb {
            box-shadow: 0 4px 10px rgba(4, 93, 105, 0.5);
        }

        /* Smooth transition on activation */
        .slider-row {
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .slider-row.active {
            transform: translateY(-1px);
        }

        /* Optional: light glass shadow for tick labels */
        .tick-label {
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }


        /* ===== SLIDER WRAPPER ===== */
        .slider-control {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 48px;
        }

        /* ===== RANGE BASE ===== */
        input[type="range"] {
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 10px;
            background: linear-gradient(to right, #03363d 50%, rgba(4, 93, 105, 0.2) 50%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            transition: background 0.2s ease-in-out;
            outline: none;
            cursor: pointer;
        }

        /* ===== ACTIVE FILL BEHAVIOR ===== */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            border-radius: 10px;
            background: transparent;
        }

        /* ===== THUMB ===== */
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #03363d;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(4, 93, 105, 0.6);
            cursor: pointer;
            margin-top: -5px;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(4, 93, 105, 0.8);
        }

        /* ===== INACTIVE SLIDERS ===== */
        .slider-row:not(.active) input[type="range"]::-webkit-slider-thumb {
            background: #d8d8d8;
            box-shadow: none;
            border: 2px solid #ccc;
        }

        /* ===== TICKS ===== */
        .slider-ticks {
            display: flex;
            justify-content: space-between;
            margin-top: -13px;
            position: relative;
        }

        .slider-ticks span {
            position: relative;
            font-size: 11px;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
        }

        .slider-ticks span::before {
            content: "";
            display: block;
            width: 2px;
            height: 8px;
            background: #888;
            border-radius: 1px;
            margin-bottom: 4px;
        }

        .range-bar-container {
            position: relative;
            height: 60px;
            margin: 20px 0 10px 0;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        /* Graph Hover Effects */
        .graph-hover-line {
            position: absolute;
            top: 0;
            bottom: 12px;
            /* Match x-axis vertical pos */
            width: 0;
            border-left: 2px dashed #03363d;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .graph-hover-label {
            position: absolute;
            top: -28px;
            background: #03363d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            transform: translateX(-50%);
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        .graph-hover-label::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #03363d;
        }

        /* ===== RESET ICON ===== */
        #resetSliders:hover {
            color: #045d69;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }



        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #03363d;
            /* white center */
            border: 2px solid #fff;
            /* blue border */
            box-shadow: 0 0 6px rgba(4, 93, 105, 0.4);
            /* soft blue glow */
            cursor: pointer;
            margin-top: -5px;
            transition: all 0.2s ease;
        }

        /* Hover effect (slightly larger and brighter) */
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(4, 93, 105, 0.7);
        }

        /* Active slider row (stronger glow) */
        .slider-row.active input[type="range"]::-webkit-slider-thumb {
            background: #03363d;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(4, 93, 105, 0.6);
        }

        /* Inactive (dimmed) sliders */
        .slider-row:not(.active) input[type="range"]::-webkit-slider-thumb {
            background: #045d69;
            border: 2px solid #ccc;
            box-shadow: none;
        }

        .country_modal label {
            top: 0;
            transform: translateY(-50%);
            font-size: 9px;
            color: #343434;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: white;
        }


        #account-name-display {
            font-weight: 600;
            /* slightly bold */
            color: #000;
            /* pure black */
            letter-spacing: 0.3px;

            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.15);
        }


        #home-btn {
            cursor: pointer;
        }

        #client-name-display {
            cursor: pointer;
        }

        .graph-hover-line {
            position: absolute;
            width: 1px;
            background: #333;
            pointer-events: none;
            display: none;
            z-index: 5;
        }


        .graph-hover-label {
            position: absolute;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            display: none;
            z-index: 6;
        }
    </style>
</head>

<body>
    <div id="avrl-glass-container">
        <!-- Header -->
        <div id="avrl-glass-header">
            <span id="client-name-display">AVRL Glass</span>
            <!-- <span style="font-size: 9px; opacity: 0.5; margin-left: 8px;">v2.3.88</span> -->
            <!-- <button id="logout-btn">Logout</button> -->
            <span id="account-name-display">AVRL Glass</span>
            <i class="fa-solid fa-house" id="home-btn"></i>
        </div>

        <!-- Keyboard Shortcuts Info -->
        <div class="shortcuts-info">
            <i class="fa-solid fa-keyboard"></i>
            <div class="shortcut-details">
                <div class="shortcut-row">
                    <div><kbd>Alt</kbd> + <kbd>T</kbd></div>
                    <span class="shortcut-desc">Toggle Panel</span>
                </div>
                <div class="shortcut-row">
                    <div><kbd>Alt</kbd> + <kbd>G</kbd></div>
                    <span class="shortcut-desc">Glass Mode</span>
                </div>
                <div class="shortcut-row">
                    <div><kbd>Alt</kbd> + <kbd>W</kbd></div>
                    <span class="shortcut-desc">Walkthrough Mode</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div id="avrl-glass-content">
            <!-- Account Selector -->
            <div id="account-selector-container" class="hide">
                <select id="account-selector"></select>
            </div>

            <!-- Rate Display -->
            <div id="rate-display">
                <!-- Decline/Failure Message Display -->
                <div id="bid-failure-message" class="hide"></div>

                <!-- AVRL Glass Rate Box with Graph -->
                <div class="rate-box rate-box-with-graph">
                    <div class="rate-row">
                        <div class="avrl-main-section">
                            <h4>AVRL-Glass Rate:</h4>
                            <div class="rate-main num" id="avrl-rate">$----</div>
                            <div id="avrl_rate_type" style="margin-bottom: 2px;"></div>
                            <i class="fa-solid fa-circle-info hide" id="rate-info-icon"></i>
                        </div>
                        <div class="base-fuel-stack">
                            <div class="rate-item">
                                <span class="rate-label">Base:</span>
                                <strong id="base-rate" class="num">$----</strong>
                            </div>
                          
                            <div class="rate-item">
                                <span class="rate-label">Fuel:</span>
                                <strong id="fuel-rate" class="num">$----</strong>
                            </div>

                            <div class="rate-item">
                                <span class="rate-label">Ratio:</span>
                                <strong id="base-ratio" class="num rate-ratio">--</strong>
                            </div>
                        </div>
                    </div>
                    <!-- Rate Graph (below rate info) -->
                    <div class="rate-graph-container" id="rate-graph-mini">
                        <div class="graph-zoom-icon" onclick="rateGraph.openInGuestPage()"
                            title="Expand graph in main page">
                            <i class="fa-solid fa-magnifying-glass-plus"></i>
                        </div>
                        <div class="range-bar" id="mini-range-bar" onclick="rateGraph.showModal()"></div>
                    </div>
                    <!-- Tooltip -->
                    <div class="graph-tooltip" id="graph-tooltip"></div>
                </div>

                <!-- DAT Rates Box -->
                <div class="rate-box">
                    <div class="rate-row">
                        <h4>DAT All-In:</h4>
                        <div class="rate-item">
                            <span class="rate-label">Low:</span>
                            <strong id="dat-low" class="num">$----</strong>
                        </div>
                        <div class="rate-item">
                            <span class="rate-label">Avg:</span>
                            <strong id="dat-rate" class="num">$----</strong>
                        </div>
                        <div class="rate-item">
                            <span class="rate-label">High:</span>
                            <strong id="dat-high" class="num">$----</strong>
                        </div>
                    </div>

                </div>
            </div>


            <div class="rate-box geo-box hide">
                <div class="rate-row geo-rate-row" style="align-items: flex-start;">
                    <div class="dat-row">
                        <div class="rate-item">
                            <span class="rate-label">origin-type:</span>
                            <strong id="dat-origin"></strong>
                        </div>

                        <div class="rate-item">
                            <span class="rate-label">origin-name:</span>
                            <strong id="dat-origin-name"></strong>
                        </div>

                    </div>

                    <div>
                        <div class="rate-item">
                            <span class="rate-label">dest-type:</span>
                            <strong id="dat-dest"></strong>
                        </div>

                        <div class="rate-item">
                            <span class="rate-label">dest-name:</span>
                            <strong id="dat-dest-name"></strong>
                        </div>
                    </div>



                    <div class="rate-item timeframe-item">
                        <span class="rate-label">Timeframe:</span>
                        <strong id="dat-timeframe"></strong>
                    </div>

                </div>
                <div class="rate-row-special">
                    <!-- <h4>Geo:</h4> -->



                </div>

            </div>





            <div id="rate-sliders" class="slider-card">
                <i id="resetSliders" class="reset-icon fa-solid fa-rotate-right" title="Reset all sliders"></i>
                <div class="slider-row" data-type="base">
                    <div class="slider-info">
                        <label>Base Rate + <span class="editable-percent" data-target="base">0%</span></label>
                        <span id="baseCalc" class="calc-text">--</span>
                    </div>
                    <div class="slider-control">
                        <input type="range" id="baseSlider" min="-25" max="25" step="1" value="0">
                        <div class="slider-ticks"></div>
                    </div>
                </div>

                <div class="slider-row" data-type="bid">
                    <div class="slider-info">
                        <label>Bid Sub + <span class="editable-percent" data-target="bid">0%</span></label>
                        <span id="bidCalc" class="calc-text">--</span>
                    </div>
                    <div class="slider-control">
                        <input type="range" id="bidSlider" min="-25" max="25" step="1" value="0">
                        <div class="slider-ticks"></div>
                    </div>
                </div>

                <div class="slider-row" data-type="margin">
                    <div class="slider-info">
                        <label>Base Rate + Premium  <span class="editable-percent"
                                data-target="margin">0%</span></label>
                        <span id="marginCalc" class="calc-text">--</span>
                    </div>
                    <div class="slider-control">
                        <input type="range" id="marginSlider" min="-25" max="25" step="1" value="0">
                        <div class="slider-ticks"></div>
                    </div>
                </div>
            </div>


            <!-- Modal -->
            <div id="percentModal" class="modal">
                <div class="modal-content">
                    <h4>Enter Custom Percentage</h4>
                    <input type="number" id="percentInput" step="0.1" placeholder="e.g. 7.5" min="-25" max="25" />
                    <div id="validationMsg" class="validation-msg">Value must be between -25 and 25</div>
                    <div class="modal-actions">
                        <button id="cancelBtn">Cancel</button>
                        <button id="applyBtn">Apply</button>
                    </div>
                </div>
            </div>

            <!-- Rate Breakdown Tooltip (appears on hover) -->
            <div id="rate-breakdown-tooltip" class="rate-tooltip hide">
                <div class="rate-tooltip-header">
                    <strong>All-in Rate Breakdown</strong>
                </div>
                <div class="rate-tooltip-content">
                    <ol id="rate-reasons-list"></ol>
                </div>
            </div>

            <!-- Form Container -->
            <div id="form-container">
                <!-- Stops Container (grid and add button created dynamically) -->
                <div id="stops-container"></div>

                <!-- Dynamic Form Fields -->
                <div id="dynamic-form"></div>

                <!-- Show More Toggle for Main Form -->
                <div id="form-show-more-toggle" class="hide" onclick="app.toggleFormExtraFields()">
                    <span>Show More</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>

                <!-- Extra Form Fields Container -->
                <div id="form-extra-fields" class="hide"></div>
            </div>

            <!-- Action Buttons -->
            <div id="form-actions">
                <button id="fetch-rate-btn">Fetch Rate</button>
                <button id="reset-btn">Reset</button>
            </div>
        </div>
    </div>

    <!-- Location Edit Modal -->
    <div id="location-modal" class="hide">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Location</h3>
                <i class="fa-solid fa-times" onclick="app.closeLocationModal()"></i>
            </div>
            <div class="modal-body">
                <div class="input-field" style="position: relative;">
                    <input type="text" id="modal-zip" placeholder=" " maxlength="10" autocomplete="off">
                    <label>ZIP Code</label>
                    <i class="fa-solid fa-download zip-fetch-icon hide" id="zip-fetch-icon" onclick="app.fetchFromZip()"
                        title="Fetch from ZIP"></i>
                </div>
                <div class="input-field">
                    <input type="text" id="modal-city" placeholder=" " autocomplete="off">
                    <label>City</label>
                </div>
                <div class="input-field">
                    <select id="modal-state">
                        <option value="">Select State</option>
                    </select>
                    <label>State / Province</label>
                </div>
                <div class="input-field country_modal">
                    <select id="modal-country" autocomplete="off">
                        <option value="US">USA</option>
                        <option value="CA">Canada</option>
                    </select>
                    <label>Country</label>
                </div>

                <!-- Show More Toggle -->
                <div id="show-more-toggle" class="hide" onclick="app.toggleExtraFields()">
                    <span>Show More</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>

                <!-- Extra Fields Container -->
                <div id="modal-extra-fields" class="hide"></div>
            </div>
            <div class="modal-footer">
                <button onclick="app.saveLocation()">Save</button>
                <button onclick="app.closeLocationModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-container" class="hide">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Rate Graph Modal -->
    <div id="rate-graph-modal">
        <div class="graph-modal-content">
            <div class="graph-modal-header">
                <h3>Glass Rate Breakdown</h3>
                <i class="fa-solid fa-times graph-modal-close" onclick="rateGraph.closeModal()"></i>
            </div>
            <div class="graph-modal-body">
                <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
                    <div class="range-bar" id="modal-range-bar" style="height: 60px;"></div>
                    <div class="graph-legend" id="graph-legend"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="rate-info-tooltip" class="rate-info-tooltip">
        <div class="rate-info-header">
            <strong id="rate-info-title">Rate Info</strong>
        </div>
        <div class="rate-info-content" id="rate-info-content"></div>
    </div>





    <script>

        (function () {
            function handlePaste(e) {
                const target = e.target;

                // Only input / textarea / contenteditable
                if (
                    !(target instanceof HTMLInputElement) &&
                    !(target instanceof HTMLTextAreaElement) &&
                    !target.isContentEditable
                ) {
                    return;
                }

                e.preventDefault(); // stop default paste

                const pastedText =
                    (e.clipboardData || window.clipboardData).getData('text');

                // CLEAR FIRST
                if (target.isContentEditable) {
                    target.innerHTML = '';
                    document.execCommand('insertText', false, pastedText);
                } else {
                    target.value = pastedText;
                }

                // Trigger events so frameworks react
                target.dispatchEvent(new Event('input', { bubbles: true }));
                target.dispatchEvent(new Event('change', { bubbles: true }));
            }

            // Capture phase so nothing beats us
            document.addEventListener('paste', handlePaste, true);
        })();


        /* ======================================================
           GLOBALS & FORMATTERS
        ====================================================== */
        let global_recommended_rate = 0;

        function fmtUS(num, decimals = 2) {
            if (num == null || isNaN(num)) return "";
            return Number(num).toLocaleString("en-US", {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
            });
        }

        function fmtUSInt(num) {
            if (num == null || isNaN(num)) return "";
            return Number(num).toLocaleString("en-US");
        }

        /* ======================================================
           SLIDER FILL HELPER
        ====================================================== */
        function updateSliderFill(slider) {
            const min = Number(slider.min || 0);
            const max = Number(slider.max || 100);
            const pct = ((slider.value - min) / (max - min)) * 100;

            slider.style.background = `
        linear-gradient(to right,
            #03363d ${pct}%,
            rgba(4, 93, 105, 0.2) ${pct}%)
    `;
        }

        /* ======================================================
           INIT SLIDER FILL (ON LOAD)
        ====================================================== */
        function initSliderFill() {
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.addEventListener("input", () => updateSliderFill(slider));
                updateSliderFill(slider);
            });
        }

        /* ======================================================
           RANGE GRAPH ZOOM
        ====================================================== */
        function resizeRangeIfNeeded(container, bidSubValue) {
            if (!container || bidSubValue == null) return;

            const global = window.rangeBarGlobal || {};
            const { lastStart, lastEnd } = global;
            if (lastStart == null || lastEnd == null) return;

            const rangeWidth = lastEnd - lastStart;
            const margin = rangeWidth * 0.1;

            if (bidSubValue > lastStart + margin && bidSubValue < lastEnd - margin) return;

            const zoomOutFactor = 1.4;
            const newWidth = Math.ceil((rangeWidth * zoomOutFactor) / 25) * 25;
            const newStart = Math.floor((bidSubValue - newWidth / 2) / 25) * 25;
            const newEnd = newStart + newWidth;

            rateGraph.createRangeBar(container, window.global_range_data, {
                start: newStart,
                end: newEnd,
                bidSubValue,
            });

            window.rangeBarGlobal.lastStart = newStart;
            window.rangeBarGlobal.lastEnd = newEnd;
        }

        /* ======================================================
           SLIDER CHANGE  GRAPH UPDATE
        ====================================================== */
        function onSliderChange(type, value, finalValue) {
            const container = document.getElementById("mini-range-bar");
            if (!container) return;

            const numericValue =
                typeof finalValue === "string"
                    ? parseFloat(finalValue.replace(/,/g, ""))
                    : finalValue;

            resizeRangeIfNeeded(container, numericValue);

            if (!container._bidMarker) {
                rateGraph.createRangeBar(container, window.global_range_data, {
                    bidSubValue: numericValue,
                });
                return;
            }

            const { line, pill, minValue, range } = container._bidMarker;
            const pct = ((numericValue - minValue) / range) * 100;

            if (pct >= 0 && pct <= 100) {
                line.style.left = `${pct}%`;
                pill.style.left = `${pct}%`;
                pill.title = `$${fmtUS(numericValue)}`;
                line.style.display = pill.style.display = "block";
            } else {
                line.style.display = pill.style.display = "none";
            }
        }

        /* ======================================================
           COPY ON SLIDER RELEASE
        ====================================================== */
        function handleCopyOnReleaseForAll() {
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                ["mouseup", "touchend"].forEach(evt => {
                    slider.addEventListener(evt, () => {
                        const row = slider.closest(".slider-row");
                        if (!row?.classList.contains("active")) return;

                        const type = row.dataset.type;
                        const calcEl = document.getElementById(`${type}Calc`);
                        if (!calcEl?.dataset.finalValue) return;

                        copyToClipboard(
                            calcEl.dataset.finalValue.replace(/[$,]/g, ""),
                            type
                        );
                    });
                });
            });
        }

        function copyToClipboard(value, type) {
            const message = `Copied ${type[0].toUpperCase() + type.slice(1)} Value: ${value}`;

            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(value)
                    .then(() => showToast(message, "success"))
                    .catch(() => fallbackCopy(value, message));
            } else {
                fallbackCopy(value, message);
            }
        }

        function fallbackCopy(value, message) {
            try {
                const textarea = document.createElement("textarea");
                textarea.value = value;
                textarea.style.position = "fixed";
                textarea.style.opacity = "0";
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                textarea.remove();
                showToast(message, "success");
            } catch {
                showToast("Clipboard not available", "error");
            }
        }

        function showToast(message, type) {
            window.parent.postMessage({
                source: "avrl-glass-client",
                action: "show-toast",
                message,
                type,
            }, "*");
            flashActiveThumb();
        }

        /* ======================================================
           COPY FEEDBACK GLOW
        ====================================================== */
        function flashActiveThumb() {
            const slider = document.querySelector(".slider-row.active input[type='range']");
            if (!slider) return;
            slider.classList.add("copied-thumb");
            setTimeout(() => slider.classList.remove("copied-thumb"), 300);
        }

        /* ======================================================
           SLIDER INITIALIZATION
        ====================================================== */

        function initRateSliders({ base, bidSub, premium }) {
            const container = document.getElementById("rate-sliders");
            if (container) container.style.display = "flex";

            const modal = document.getElementById("percentModal");
            const input = document.getElementById("percentInput");
            const validationMsg = document.getElementById("validationMsg");
            const cancelBtn = document.getElementById("cancelBtn");
            const applyBtn = document.getElementById("applyBtn");
            let currentTarget = null;
            const min = -25, max = 25, range = max - min;

            const sliders = [
                {
                    id: "baseSlider",
                    type: "base",
                    calc: "baseCalc",
                    formula: (x) => `${fmtUS(base)} + ${x}% = ${fmtUS(base * (1 + x / 100))}`,
                    final: (x) => (base * (1 + x / 100)).toFixed(2),
                },
                {
                    id: "bidSlider",
                    type: "bid",
                    calc: "bidCalc",
                    formula: (x) => `${fmtUS(bidSub)} + ${x}% = ${fmtUS(bidSub * (1 + x / 100))}`,
                    final: (x) => (bidSub * (1 + x / 100)).toFixed(2),
                },
                {
                    id: "marginSlider",
                    type: "margin",
                    calc: "marginCalc",
                    formula: (x) =>
                        `${fmtUS(base)} + ${fmtUS(premium)}  ${x}% = ${fmtUS(base + (x / 100) * premium)}`,
                    final: (x) => (base + (x / 100) * premium).toFixed(2),
                },
            ];

            // Add ticks
            const tickValues = [-25, -15, -5, 0, 5, 15, 25];
            document.querySelectorAll(".slider-ticks").forEach((container) => {
                if (!container.children.length) {
                    tickValues.forEach((v) => {
                        const tick = document.createElement("div");
                        tick.className = "tick";
                        const pct = ((v - min) / range) * 100;
                        tick.style.left = pct + "%";
                        tick.innerHTML = `<div class="tick-line"></div><div class="tick-label">${v}</div>`;
                        container.appendChild(tick);
                    });
                }
            });

            // Core update logic
            function updateSlider(activeId, val, trigger = false) {
                sliders.forEach((s) => {
                    const slider = document.getElementById(s.id);
                    const calcEl = document.getElementById(s.calc);
                    const row = slider.closest(".slider-row");
                    const percentSpan = document.querySelector(`.editable-percent[data-target="${s.id.replace("Slider", "")}"]`);

                    if (s.id === activeId) {
                        const finalValue = s.final(val);
                        calcEl.textContent = s.formula(val);
                        calcEl.dataset.finalValue = finalValue;
                        percentSpan.textContent = `${val}%`;
                        slider.value = val;
                        row.classList.add("active");
                        if (trigger) onSliderChange(s.type, val, finalValue);
                    } else {
                        slider.value = 0;
                        calcEl.textContent = s.formula(0);
                        calcEl.dataset.finalValue = s.final(0);
                        percentSpan.textContent = "0%";
                        row.classList.remove("active");
                    }

                    const fill = ((slider.value - min) / (max - min)) * 100;
                    slider.style.background = `
        linear-gradient(to right,
            #03363d ${fill}%,
            rgba(4, 93, 105, 0.2) ${fill}%)
    `;
                });
            }

            // Listeners
            //   sliders.forEach((s) => {
            //     const slider = document.getElementById(s.id);
            //     slider.addEventListener("input", () => updateSlider(s.id, Number(slider.value), true));
            //     updateSlider(s.id, 0, false);
            //   });

            sliders.forEach((s) => {
                const slider = document.getElementById(s.id);

                // When user interacts, make it active
                slider.addEventListener("input", () => updateSlider(s.id, Number(slider.value), true));

                // Initialize silently without marking active
                const row = slider.closest(".slider-row");
                if (row) row.classList.remove("active");
                const calcEl = document.getElementById(s.calc);
                calcEl.textContent = s.formula(0);
                calcEl.dataset.finalValue = s.final(0);
                slider.value = 0;

                const min = slider.min ? slider.min : 0;
                const max = slider.max ? slider.max : 100;
                const fill = ((slider.value - min) / (max - min)) * 100;
                slider.style.background = `
        linear-gradient(to right,
            #03363d ${fill}%,
            rgba(4, 93, 105, 0.2) ${fill}%)
    `;
            });


            // Editable % modal
            document.querySelectorAll(".editable-percent").forEach((el) => {
                el.addEventListener("click", () => {
                    currentTarget = el.dataset.target;
                    const slider = document.getElementById(`${currentTarget}Slider`);
                    input.value = slider.value;
                    validationMsg.style.visibility = "hidden";
                    modal.style.display = "flex";
                    input.focus();
                });
            });
            cancelBtn.onclick = () => (modal.style.display = "none");
            applyBtn.onclick = () => {
                const val = parseFloat(input.value);
                if (isNaN(val) || val < min || val > max) {
                    validationMsg.style.visibility = "visible";
                    return;
                }
                updateSlider(`${currentTarget}Slider`, val, true);
                modal.style.display = "none";
            };

            window._sliderCtx = { base, bidSub, premium };
            window._updateSlider = (id, val, trigger = false) => updateSlider(id, val, trigger);

            // Enable copy-on-release
            handleCopyOnReleaseForAll();
        }

        /* ======================================================
           RESET
        ====================================================== */
        function reset_sliders_value() {
            ["baseSlider", "bidSlider", "marginSlider"].forEach(id =>
                window._updateSlider?.(id, 0, true)
            );

            document.querySelectorAll(".slider-row").forEach(r => r.classList.remove("active"));

            const container = document.getElementById("mini-range-bar");
            if (container) {
                resizeRangeIfNeeded(container, global_recommended_rate);
                rateGraph.createRangeBar(container, window.global_range_data, {
                    bidSubValue: global_recommended_rate,
                });
            }
        }

        /* ======================================================
           BOOTSTRAP
        ====================================================== */
        document.addEventListener("DOMContentLoaded", () => {
            initSliderFill();
            document.getElementById("resetSliders")?.addEventListener("click", reset_sliders_value);
        });
    </script>

    <script>
        var COUNTRY_REGION_MAP = {
            USA: {
                states: [
                    { code: "AL", name: "Alabama" },
                    { code: "AK", name: "Alaska" },
                    { code: "AZ", name: "Arizona" },
                    { code: "AR", name: "Arkansas" },
                    { code: "CA", name: "California" },
                    { code: "CO", name: "Colorado" },
                    { code: "CT", name: "Connecticut" },
                    { code: "DE", name: "Delaware" },
                    { code: "FL", name: "Florida" },
                    { code: "GA", name: "Georgia" },
                    { code: "HI", name: "Hawaii" },
                    { code: "ID", name: "Idaho" },
                    { code: "IL", name: "Illinois" },
                    { code: "IN", name: "Indiana" },
                    { code: "IA", name: "Iowa" },
                    { code: "KS", name: "Kansas" },
                    { code: "KY", name: "Kentucky" },
                    { code: "LA", name: "Louisiana" },
                    { code: "ME", name: "Maine" },
                    { code: "MD", name: "Maryland" },
                    { code: "MA", name: "Massachusetts" },
                    { code: "MI", name: "Michigan" },
                    { code: "MN", name: "Minnesota" },
                    { code: "MS", name: "Mississippi" },
                    { code: "MO", name: "Missouri" },
                    { code: "MT", name: "Montana" },
                    { code: "NE", name: "Nebraska" },
                    { code: "NV", name: "Nevada" },
                    { code: "NH", name: "New Hampshire" },
                    { code: "NJ", name: "New Jersey" },
                    { code: "NM", name: "New Mexico" },
                    { code: "NY", name: "New York" },
                    { code: "NC", name: "North Carolina" },
                    { code: "ND", name: "North Dakota" },
                    { code: "OH", name: "Ohio" },
                    { code: "OK", name: "Oklahoma" },
                    { code: "OR", name: "Oregon" },
                    { code: "PA", name: "Pennsylvania" },
                    { code: "RI", name: "Rhode Island" },
                    { code: "SC", name: "South Carolina" },
                    { code: "SD", name: "South Dakota" },
                    { code: "TN", name: "Tennessee" },
                    { code: "TX", name: "Texas" },
                    { code: "UT", name: "Utah" },
                    { code: "VT", name: "Vermont" },
                    { code: "VA", name: "Virginia" },
                    { code: "WA", name: "Washington" },
                    { code: "WV", name: "West Virginia" },
                    { code: "WI", name: "Wisconsin" },
                    { code: "WY", name: "Wyoming" },
                    { code: "DC", name: "District of Columbia" }
                ],

                territories: [
                    { code: "PR", name: "Puerto Rico" },
                    { code: "GU", name: "Guam" },
                    { code: "VI", name: "U.S. Virgin Islands" },
                    { code: "AS", name: "American Samoa" },
                    { code: "MP", name: "Northern Mariana Islands" }
                ]
            },

            CANADA: {
                provinces: [
                    { code: "AB", name: "Alberta" },
                    { code: "BC", name: "British Columbia" },
                    { code: "MB", name: "Manitoba" },
                    { code: "NB", name: "New Brunswick" },
                    { code: "NL", name: "Newfoundland and Labrador" },
                    { code: "NS", name: "Nova Scotia" },
                    { code: "ON", name: "Ontario" },
                    { code: "PE", name: "Prince Edward Island" },
                    { code: "QC", name: "Quebec" },
                    { code: "SK", name: "Saskatchewan" }
                ],

                territories: [
                    { code: "NT", name: "Northwest Territories" },
                    { code: "NU", name: "Nunavut" },
                    { code: "YT", name: "Yukon" }
                ]
            }
        };

        function showToast(message, duration) {
            window.parent.postMessage({
                source: 'avrl-glass-client',
                action: 'show-toast',
                message: message,
                duration: duration || 2000
            }, '*');
        }

        // Storage Bridge API
        var storageAPI = (function () {
            let requestId = 0;
            let pendingRequests = {};
            window.addEventListener('message', function (event) {
                if (!event.data || event.data.source !== 'avrl-glass-bridge') return;
                const { action, requestId: respId, data, success } = event.data;
                if (action === 'bridge.ready') return;
                if (pendingRequests[respId]) {
                    pendingRequests[respId](action.includes('response') ? (data || { success }) : null);
                    delete pendingRequests[respId];
                }
            });
            function sendMessage(action, data, callback) {
                const id = ++requestId;
                pendingRequests[id] = callback;
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: action,
                    requestId: id,
                    data: data
                }, '*');
                setTimeout(function () {
                    if (pendingRequests[id]) {
                        console.warn('Storage request timed out:', action);
                        pendingRequests[id](null);
                        delete pendingRequests[id];
                    }
                }, 5000);
            }
            return {
                get: function (keys, callback) {
                    sendMessage('storage.get', { keys: keys }, callback);
                },
                set: function (items, callback) {
                    sendMessage('storage.set', { items: items }, callback || function () { });
                },
                remove: function (keys, callback) {
                    sendMessage('storage.remove', { keys: keys }, callback || function () { });
                },
                redirect: function (url) {
                    window.parent.postMessage({
                        source: 'avrl-glass-client',
                        action: 'redirect',
                        data: { url: url }
                    }, '*');
                }
            };
        })();

        // Selected Text Filler
        var selectedTextFiller = (function () {
            let currentInput = null;
            let waitingForText = false;

            function sanitizeText(text) {
                if (!text) return '';
                text = text.trim();
                text = text.replace(/[^\w\s.,\-()]+$/g, '');
                text = text.trim();
                return text;
            }



            window.addEventListener('message', function (event) {
                if (!event.data || event.data.source !== 'avrl-glass-bridge') return;
                if (event.data.action === 'selected-text-response' && waitingForText && currentInput) {
                    const text = event.data.text;
                    if (text && text.length > 0) {
                        const sanitizedText = sanitizeText(text);
                        if (sanitizedText) {
                            currentInput.value = sanitizedText;
                            currentInput.dispatchEvent(new Event('input', { bubbles: true }));
                            currentInput.dispatchEvent(new Event('change', { bubbles: true }));
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'clear-selection'
                            }, '*');
                        }
                    }
                    waitingForText = false;
                    currentInput = null;
                }
            });

            function enableForInput(inputElement) {
                inputElement.addEventListener('focus', function () {
                    currentInput = this;
                    waitingForText = true;
                    window.parent.postMessage({
                        source: 'avrl-glass-client',
                        action: 'get-selected-text'
                    }, '*');
                });
            }

            function enableForAllInputs() {
                document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(enableForInput);
            }

            return {
                enableForAllInputs: enableForAllInputs
            };
        })();

        // Rate Graph Visualization
        var rateGraph = (function () {
            let currentRateData = null;
            const premiumColors = [
                '#9c27b0', '#e91e63', '#f44336', '#ff9800', '#ffc107',
                '#cddc39', '#8bc34a', '#4caf50', '#009688', '#03363d',
                '#03a9f4', '#2196f3', '#3f51b5', '#673ab7', '#9c27b0'
            ];

            function getPremiumColor(index) {
                return premiumColors[index % premiumColors.length];
            }

            function createRangeBar(containerElement, rateData, options = {}) {
                if (!rateData || !containerElement) return;
                const {
                    start = null,
                    end = null,
                    bidSubValue = null
                } = options;
                if (bidSubValue !== null && containerElement._bidMarker && start === null && end === null && options.quickUpdateOnly) {
                    const { line, pill, minValue, range } = containerElement._bidMarker;
                    const pct = ((bidSubValue - minValue) / range) * 100;
                    if (pct >= 0 && pct <= 100) {
                        line.style.left = `${pct}%`;
                        pill.style.left = `${pct}%`;
                        line.style.display = 'block';
                        pill.style.display = 'block';
                    } else {
                        line.style.display = 'none';
                        pill.style.display = 'none';
                    }
                    return;
                }

                containerElement.innerHTML = '';
                const datLow = rateData.datLow || 0;
                const datHigh = rateData.datHigh || 0;
                const datRate = rateData.datRate || 0;
                const baseRate = rateData.baseRate || 0;
                const avrlRate = rateData.avrlRate || 0;
                const bidSub = bidSubValue !== null ? bidSubValue : rateData.bidSub || null;

                if (datLow === 0 && datHigh === 0 && !bidSub) return;

                let minValue, maxValue;
                if (start !== null && end !== null) {
                    minValue = start;
                    maxValue = end;
                } else {
                    const values = [datLow, datHigh, datRate, baseRate, avrlRate];
                    if (bidSub !== null) values.push(bidSub);
                    const actualMin = Math.min(...values.filter(v => !isNaN(v)));
                    const actualMax = Math.max(...values.filter(v => !isNaN(v)));
                    const spread = actualMax - actualMin || 100;
                    const padding = Math.ceil(spread * 0.4 / 25) * 25;
                    minValue = Math.floor((actualMin - padding) / 25) * 25;
                    maxValue = Math.ceil((actualMax + padding) / 25) * 25;
                }
                const range = maxValue - minValue;

                window.rangeBarGlobal = window.rangeBarGlobal || {};
                window.rangeBarGlobal.lastStart = minValue;
                window.rangeBarGlobal.lastEnd = maxValue;

                const xAxis = document.createElement('div');
                xAxis.className = 'x-axis';
                xAxis.style.cssText = `
    position:absolute;
    left:0;
    right:0;
    bottom:12px;
    height:2px;
    background:#ccc;
    z-index:1;
    border:none;
    overflow:hidden;
  `;
                containerElement.appendChild(xAxis);

                // --- Hover Line Elements ---
                const hoverLine = document.createElement('div');
                hoverLine.className = 'graph-hover-line';
                containerElement.appendChild(hoverLine);

                const hoverLabel = document.createElement('div');
                hoverLabel.className = 'graph-hover-label';
                containerElement.appendChild(hoverLabel);

                // Mouse Events for Hover Line
                // containerElement.addEventListener('mousemove', (e) => {
                //     const rect = containerElement.getBoundingClientRect();
                //     let x = e.clientX - rect.left;

                //     // Clamp x within container bounds
                //     if (x < 0) x = 0;
                //     if (x > rect.width) x = rect.width;

                //     const pct = (x / rect.width) * 100;

                //     // Calculate value based on position
                //     const val = minValue + (x / rect.width) * range;

                //     hoverLine.style.left = pct + '%';
                //     hoverLine.style.display = 'block';

                //     hoverLabel.style.left = pct + '%';
                //     hoverLabel.textContent = '$' + Math.round(val).toLocaleString();
                //     hoverLabel.style.display = 'block';
                // });


                containerElement.addEventListener('mousemove', (e) => {
                    const rect = containerElement.getBoundingClientRect();

                    // X relative to container
                    let x = e.clientX - rect.left;
                    x = Math.max(0, Math.min(x, rect.width));

                    // Y relative to container
                    let y = e.clientY - rect.top;
                    y = Math.max(0, Math.min(y, rect.height));

                    const value = minValue + (x / rect.width) * range;

                    const xAxisBottom = 12; // must match x-axis CSS
                    const lineHeight = rect.height - y - xAxisBottom;

                    if (lineHeight <= 0) {
                        hoverLine.style.display = 'none';
                        hoverLabel.style.display = 'none';
                        return;
                    }

                    // Hover line: from x-axis to cursor
                    hoverLine.style.left = `${x}px`;
                    hoverLine.style.bottom = `${xAxisBottom}px`;
                    hoverLine.style.height = `${lineHeight}px`;
                    hoverLine.style.display = 'block';

                    // Hover label above cursor
                    hoverLabel.style.left = `${x}px`;
                    hoverLabel.style.top = `${y - 22}px`;
                    hoverLabel.textContent = `$${Math.round(value).toLocaleString('en-US')}`;
                    hoverLabel.style.display = 'block';
                });

                containerElement.addEventListener('mouseleave', () => {
                    hoverLine.style.display = 'none';
                    hoverLabel.style.display = 'none';
                });
                // ---------------------------

                let tickStep = 25;
                let labelStep = 100;
                if (range > 1000 && range <= 5000) {
                    tickStep = 50; labelStep = 250;
                } else if (range > 5000 && range <= 10000) {
                    tickStep = 100; labelStep = 500;
                } else if (range > 10000) {
                    tickStep = 250; labelStep = 1000;
                }

                for (let v = Math.floor(minValue / tickStep) * tickStep; v <= Math.ceil(maxValue / tickStep) * tickStep; v += tickStep) {
                    const pct = ((v - minValue) / range) * 100;
                    const tick = document.createElement('div');
                    const tickHeight = v % labelStep === 0 ? 8 : v % (tickStep * 2) === 0 ? 5 : 3;
                    tick.style.cssText = `
      position:absolute;left:${pct}%;bottom:12px;
      width:1px;height:${tickHeight}px;
      background:#888;transform:translateX(-50%);z-index:1;
    `;
                    containerElement.appendChild(tick);
                    if (v % labelStep === 0) {
                        const lbl = document.createElement('div');
                        lbl.className = 'axis-label';
                        lbl.textContent = `$${Number(v).toLocaleString('en-US')}`;
                        lbl.style.cssText = `
        position:absolute;left:${pct}%;bottom:-4px;
        font-size:10px;color:#555;transform:translateX(-50%);
        z-index:1;white-space:nowrap;
      `;
                        containerElement.appendChild(lbl);
                    }
                }

                const stackedBar = document.createElement('div');
                stackedBar.className = 'stacked-bar-horizontal';
                stackedBar.style.cssText = `
    position:absolute;bottom:30px;height:10px;
    background:#eee;overflow:hidden;z-index:2;
    border-radius:0;
    width:${((avrlRate - minValue) / range) * 100}%;
    left:0;
  `;

                const baseSeg = document.createElement('div');
                const baseWidthPercent = ((baseRate - minValue) / (avrlRate - minValue)) * 100;
                baseSeg.style.cssText = `
    position:absolute;top:0;bottom:0;left:0;
    width:${baseWidthPercent}%;
    background:#2196f3;border-radius:0;
    cursor:pointer;
  `;
                baseSeg.addEventListener('mouseenter', (e) =>
                    showRateTooltip(e, 'Base Rate Transformations', rateData.base_rate_transformation)
                );
                baseSeg.addEventListener('mouseleave', hideRateTooltip);
                stackedBar.appendChild(baseSeg);

                const premiumSeg = document.createElement('div');
                const premiumWidthPercent = (rateData.paTotal / (avrlRate - minValue)) * 100;
                premiumSeg.style.cssText = `
    position:absolute;top:0;bottom:0;
    left:${baseWidthPercent}%;
    width:${premiumWidthPercent}%;
    background:#9c27b0;border-radius:0;
    cursor:pointer;
  `;
                premiumSeg.addEventListener('mouseenter', (e) =>
                    showPremiumTooltip(e, rateData.premiums, rateData.paTotal)
                );
                premiumSeg.addEventListener('mouseleave', hideRateTooltip);
                stackedBar.appendChild(premiumSeg);
                containerElement.appendChild(stackedBar);

                const markers = [
                    { label: 'L', value: datLow, color: '#4caf50' },
                    { label: 'A', value: datRate, color: '#03a9f4' },
                    { label: 'H', value: datHigh, color: '#ff9800' },
                ];
                markers.forEach((m) => {
                    const pct = ((m.value - minValue) / range) * 100;
                    const line = document.createElement('div');
                    line.style.cssText = `
      position:absolute;left:${pct}%;bottom:10px;width:1px;height:45px;
      background:${m.color};transform:translateX(-50%);z-index:3;
    `;
                    const pill = document.createElement('div');
                    pill.textContent = m.label;
                    pill.title = `${m.label}: $${Number(m.value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    pill.style.cssText = `
      position:absolute;left:${pct}%;bottom:45px;transform:translateX(-50%);
      background:#fff;border:1px solid ${m.color};color:${m.color};
      border-radius:4px;padding:1px 5px;font-size:9px;font-weight:600;z-index:3;
    `;
                    containerElement.appendChild(line);
                    containerElement.appendChild(pill);
                });

                const bidMarkerLine = document.createElement('div');
                const bidMarkerPill = document.createElement('div');
                bidMarkerLine.id = 'bid-sub-marker-line';
                bidMarkerPill.id = 'bid-sub-marker-pill';
                bidMarkerPill.title = `Bid Sub: $${Number(bidSub).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                bidMarkerPill.textContent = 'Bid Sub';
                const markerCommonCSS = `
    position:absolute;transform:translateX(-50%);
    z-index:4;display:none;
  `;
                bidMarkerLine.style.cssText = `
    ${markerCommonCSS}
    bottom:11px;
    width:2px;
    height:53px;
    background:#e91e63;
  `;
                bidMarkerPill.style.cssText = `
    ${markerCommonCSS}
    bottom:60px;
    background:#fff;border:1px solid #e91e63;color:#e91e63;
    border-radius:4px;padding:1px 5px;font-size:9px;font-weight:600;
  `;
                containerElement.appendChild(bidMarkerLine);
                containerElement.appendChild(bidMarkerPill);

                containerElement._bidMarker = { line: bidMarkerLine, pill: bidMarkerPill, minValue, range };

                if (bidSub !== null) {
                    const pct = ((bidSub - minValue) / range) * 100;
                    if (pct >= 0 && pct <= 100) {
                        bidMarkerLine.style.left = `${pct}%`;
                        bidMarkerPill.style.left = `${pct}%`;
                        bidMarkerLine.style.display = 'block';
                        bidMarkerPill.style.display = 'block';
                    }
                }
            }

            function adjustBrightness(color, percent) {
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) + amt;
                const G = (num >> 8 & 0x00FF) + amt;
                const B = (num & 0x0000FF) + amt;
                return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255))
                    .toString(16).slice(1);
            }

            function showTooltip(event, label, value, details) {
                const tooltip = document.getElementById('graph-tooltip');
                tooltip.classList.add("show");
                if (!tooltip) return;
                let content = '<strong>' + label + '</strong>';
                if (value > 0) {
                    content += ': $' + value.toFixed(2);
                }
                if (details) {
                    content += '<br><span style="font-size: 10px;">' + details + '</span>';
                }
                tooltip.innerHTML = content;
                tooltip.classList.add('show');
                const miniGraphContainer = document.getElementById('rate-graph-mini');
                if (miniGraphContainer) {
                    const containerRect = miniGraphContainer.getBoundingClientRect();
                    const left = containerRect.left + (containerRect.width / 2);
                    const top = containerRect.bottom + 8;
                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                    tooltip.style.transform = 'translateX(-50%)';
                }
            }

            function hideTooltip() {
                const tooltip = document.getElementById('graph-tooltip');
                if (tooltip) {
                    tooltip.classList.remove('show');
                }
            }

            function renderLegend(rateData) {
                const legendContainer = document.getElementById('graph-legend');
                if (!legendContainer || !rateData) return;
                legendContainer.innerHTML = '';

                const items = [];
                items.push({
                    label: 'AVRL-Glass Rate',
                    value: rateData.avrlRate,
                    color: '#03363d',
                    desc: 'Total Rate = Base + All PAs',
                    isHeader: true
                });
                items.push({
                    label: 'Base Rate',
                    value: rateData.baseRate,
                    color: '#2196f3',
                    desc: 'DAT Base Rate'
                });
                if (rateData.premiums && rateData.premiums.length > 0) {
                    items.push({
                        label: 'Total Premium Augments',
                        value: rateData.paTotal,
                        color: '#9c27b0',
                        desc: rateData.premiums.length + ' PA(s) Applied',
                        isSummary: true
                    });
                }
                items.push({ isDivider: true });
                items.push({
                    label: 'DAT High',
                    value: rateData.datHigh,
                    color: '#ff9800',
                    desc: 'DAT Upper Limit',
                    isComparison: true
                });
                items.push({
                    label: 'DAT Rate',
                    value: rateData.datRate,
                    color: '#03363d',
                    desc: 'DAT Average',
                    isComparison: true
                });
                items.push({
                    label: 'DAT Low',
                    value: rateData.datLow,
                    color: '#4caf50',
                    desc: 'DAT Lower Limit',
                    isComparison: true
                });

                items.forEach(function (item) {
                    if (item.isDivider) {
                        const divider = document.createElement('div');
                        divider.style.borderTop = '2px solid #e0e0e0';
                        divider.style.margin = '15px 0';
                        legendContainer.appendChild(divider);
                        return;
                    }
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'legend-item';
                    if (item.isHeader) {
                        itemDiv.style.background = 'rgba(4, 93, 105, 0.15)';
                        itemDiv.style.fontWeight = '600';
                    } else if (item.isSummary) {
                        itemDiv.style.background = 'rgba(156, 39, 176, 0.1)';
                        itemDiv.style.borderLeft = '3px solid #9c27b0';
                    } else if (item.isComparison) {
                        itemDiv.style.opacity = '0.7';
                    }
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'legend-color';
                    colorDiv.style.background = item.color;
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'legend-info';
                    infoDiv.innerHTML = '<strong>' + item.label + ': $' +
                        Number(item.value).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }) +
                        '</strong><span>' + item.desc + '</span>';
                    infoDiv.title = `${item.label}: $${Number(item.value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    itemDiv.appendChild(colorDiv);
                    itemDiv.appendChild(infoDiv);
                    legendContainer.appendChild(itemDiv);
                });
            }

            function updateGraph(rateData) {
                window.global_range_data = rateData
                currentRateData = rateData;
                const hasValidData = rateData && rateData.datLow > 0 && rateData.datHigh > 0;
                const graphContainer = document.getElementById('rate-graph-mini');
                if (graphContainer) {
                    if (hasValidData) {
                        graphContainer.style.display = 'flex';
                        graphContainer.style.opacity = '';
                        graphContainer.classList.add('show');
                    } else {
                        graphContainer.classList.remove('show');
                        graphContainer.style.display = 'none';
                        graphContainer.style.opacity = '0';
                    }
                }
                const miniBar = document.getElementById('mini-range-bar');
                if (miniBar && hasValidData) {
                    resetAndRenderRangeBar(miniBar, rateData, rateData["avrlRate"]);
                }
                const modalBar = document.getElementById('modal-range-bar');
                if (modalBar && hasValidData) {
                    createRangeBar(modalBar, rateData, { bidSubValue: rateData["avrlRate"] });
                }
                if (hasValidData) {
                    renderLegend(rateData);
                }

                // Show/Hide Sliders based on valid data
                const sliderCard = document.getElementById('rate-sliders');
                if (sliderCard) {
                    if (hasValidData) {
                        sliderCard.style.display = 'flex';
                    } else {
                        sliderCard.style.display = 'none';
                    }
                }
            }

            function showModal() {
                const modal = document.getElementById('rate-graph-modal');
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeModal() {
                const modal = document.getElementById('rate-graph-modal');
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            window.addEventListener('message', function (event) {
                if (event.data && event.data.source === 'avrl-glass-bridge') {
                    if (event.data.action === 'show-rate-graph' && event.data.rateData) {
                        updateGraph(event.data.rateData);
                        showModal();
                    }
                }
            });

            function openInGuestPage() {
                if (!currentRateData) {
                    showToast('No rate data available', 2000);
                    return;
                }
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'show-rate-graph',
                    rateData: currentRateData
                }, '*');
                showToast('Opening graph in main page...', 1500);
            }

            function resetAndRenderRangeBar(container, rateData, bidSubValue = null) {
                if (!container) return;
                container.innerHTML = '';
                container._bidMarker = null;
                window.rangeBarGlobal = {
                    lastStart: null,
                    lastEnd: null
                };
                rateGraph.createRangeBar(container, rateData, {
                    start: null,
                    end: null,
                    bidSubValue: bidSubValue
                });
                console.log(" Graph reset & fully re-rendered", { bidSubValue });
            }

            let tooltipHideTimer = null;
            console.log("hhhhhhhhhhhhhhhhhhhhhhh")

            function showRateTooltip(event, label, transformations) {
                const tooltip = document.getElementById('rate-info-tooltip');
                const title = document.getElementById('rate-info-title');
                const content = document.getElementById('rate-info-content');
                if (!tooltip || !content) return;
                clearTimeout(window.tooltipHideTimer);
                const mono = "font-family:'Consolas','Menlo','Courier New',monospace;";
                const fmt = (n) => (typeof n === 'number' && isFinite(n)) ? n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
                const signed = (n) => {
                    if (!(typeof n === 'number' && isFinite(n))) return '';
                    const s = n >= 0 ? '+' : '';
                    return `${s}${Math.abs(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                };
                title.textContent = 'Base Rate Transformations';
                let html = `
    <table style="width:100%;font-size:11px;border-collapse:collapse;line-height:1.45;">
      <colgroup>
        <col style="width:40%;">
        <col style="width:30%;">
        <col style="width:30%;">
      </colgroup>
      <tbody>
  `;
                if (Array.isArray(transformations) && transformations.length) {
                    transformations.forEach((t) => {
                        const isNaive = t.label === 'Naive Base Rate';
                        const isTotal = t.label === 'Base Rate';
                        const deltaColor = (t.delta ?? 0) >= 0 ? '#388e3c' : '#d32f2f';
                        const deltaFormatted = signed(t.delta);
                        if (isTotal) {
                            html += `
          <tr style="border-top:2px solid #000;font-weight:600;">
            <td style="padding:4px 6px;">${t.label}</td>
            <td></td>
            <td style="text-align:right;padding:4px 6px;${mono};font-weight:700;white-space:nowrap;">
              ${fmt(t.value)}
            </td>
          </tr>`;
                            return;
                        }
                        if (isNaive) {
                            html += `
          <tr>
            <td style="padding:4px 6px;">${t.label}</td>
            <td style="text-align:right;padding:4px 6px;${mono};white-space:nowrap;">${fmt(t.value)}</td>
            <td></td>
          </tr>`;
                            return;
                        }
                        html += `
        <tr>
          <td style="
            padding:4px 6px;
            color:#333;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            max-width:160px;
          ">
            <span title="${t.label}">${t.label}</span>
          </td>
          <td></td>
          <td style="text-align:right;padding:4px 6px;${mono};color:${deltaColor};white-space:nowrap;">
            ${deltaFormatted}
          </td>
        </tr>`;
                    });
                } else {
                    html += `<tr><td colspan="3" style="padding:4px;">No base rate transformations found.</td></tr>`;
                }
                html += `</tbody></table>`;
                content.innerHTML = html;
                positionRateTooltip(event, tooltip);
                tooltip.classList.add('show');
            }

            function showPremiumTooltip(event, premiums, total) {
                const tooltip = document.getElementById('rate-info-tooltip');
                const title = document.getElementById('rate-info-title');
                const content = document.getElementById('rate-info-content');
                if (!tooltip || !content) return;
                clearTimeout(window.tooltipHideTimer);
                title.textContent = 'Premium Augments';
                let html = `<table style="width:auto;font-size:11px;border-collapse:collapse;table-layout:auto;">`;
                if (premiums?.length) {
                    premiums.forEach((p, idx) => {
                        const desc = `${p.code}: ${p.description || ''}`.trim();
                        const shortDesc =
                            desc.length > 35
                                ? `<span title="${desc}" style="display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${desc}</span>`
                                : desc;
                        html += `
        <tr style="border-top:${idx === 0 ? 'none' : '1px solid #eee'};">
          <td style="
            padding:4px 6px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            max-width:180px;
            color:#333;
          ">
            ${shortDesc}
          </td>
          <td class="rate-num" style="
            text-align:right;
            padding:4px 6px;
            font-family:'Consolas','Menlo','Courier New',monospace;
            letter-spacing:0.3px;
            color:#111;
            white-space:nowrap;
          ">
            $${p.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
          </td>
        </tr>
      `;
                    });
                    html += `
      <tr style="border-top:1px solid #ccc;">
        <td style="padding:6px 6px;font-weight:600;color:#000;">Total</td>
        <td class="rate-num" style="
          text-align:right;
          padding:6px 6px;
          font-weight:600;
          font-family:'Consolas','Menlo','Courier New',monospace;
          color:#000;
          white-space:nowrap;
        ">
          $${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
        </td>
      </tr>
    `;
                } else {
                    html += `<tr><td colspan="2" style="padding:4px;">No premium augments found.</td></tr>`;
                }
                html += `</table>`;
                content.innerHTML = html;
                positionRateTooltip(event, tooltip);
                tooltip.classList.add('show');
            }

            function positionRateTooltip(event, tooltip) {
                const container = document.getElementById('rate-graph-mini');
                const rect = container.getBoundingClientRect();
                const tooltipWidth = tooltip.offsetWidth || 200;
                const tooltipHeight = tooltip.offsetHeight || 100;
                const left =
                    event.clientX - rect.left - tooltipWidth / 2;
                const top = event.clientY - rect.top + 100;
                const maxLeft = rect.width - tooltipWidth - 4;
                const safeLeft = Math.max(4, Math.min(left, maxLeft));
                tooltip.style.left = `${safeLeft}px`;
                tooltip.style.top = `${top}px`;
            }

            function hideRateTooltip() {
                const tooltip = document.getElementById('rate-info-tooltip');
                if (!tooltip) return;
                clearTimeout(tooltipHideTimer);
                tooltipHideTimer = setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 200);
            }

            return {
                updateGraph: updateGraph,
                showModal: showModal,
                closeModal: closeModal,
                openInGuestPage: openInGuestPage,
                createRangeBar: createRangeBar
            };
        })();

        function parsePremiumAugments(rateResponse) {
            try {
                if (
                    !rateResponse ||
                    !rateResponse.additional_data ||
                    !rateResponse.additional_data.reasons_str
                ) {
                    return {
                        premiums: [],
                        totalPA: 0,
                        baseRate: 0,
                        bidSubmitted: 0,
                        baseRateTransformations: []
                    };
                }
                const reasonsStr = rateResponse.additional_data.reasons_str;
                const premiums = [];
                const paRegex = /(\d+):\s*([^($]+)\s*\(\$(\d+(?:\.\d+)?)\)/g;
                let match;
                while ((match = paRegex.exec(reasonsStr)) !== null) {
                    const code = match[1];
                    const description = match[2].trim();
                    const amount = parseFloat(match[3]);
                    premiums.push({ code, description, amount });
                }
                const baseRateTransformations = [];
                const baseRateSection = reasonsStr.match(
                    /Base rate fed into tree is \$([\d.]+)([\s\S]*?)Bid Submitted/
                );
                if (baseRateSection) {
                    const naiveBase = parseFloat(baseRateSection[1]);
                    baseRateTransformations.push({
                        label: "Naive Base Rate",
                        value: naiveBase
                    });
                    const content = baseRateSection[2];
                    const resetRegex =
                        /Base rate reset by ([^:]+):(\d+).*?from ([\d.]+) to ([\d.]+)/g;
                    let resetMatch;
                    while ((resetMatch = resetRegex.exec(content)) !== null) {
                        const transformer = resetMatch[1].trim();
                        const code = resetMatch[2].trim();
                        const from = parseFloat(resetMatch[3]);
                        const to = parseFloat(resetMatch[4]);
                        const diff = +(to - from).toFixed(2);
                        baseRateTransformations.push({
                            label: `${code}: ${transformer}`,
                            delta: diff,
                            value: to
                        });
                    }
                }
                const baseRate = rateResponse.additional_data.base_rate || 0;
                if (baseRate)
                    baseRateTransformations.push({
                        label: "Base Rate",
                        value: baseRate
                    });
                const paTotal = rateResponse.additional_data.pa_total || 0;
                const bidSubmitted =
                    rateResponse.additional_data.bid_submitted ||
                    rateResponse.data.rate ||
                    0;
                return {
                    premiums,
                    totalPA: paTotal,
                    baseRate,
                    bidSubmitted,
                    baseRateTransformations
                };
            } catch (e) {
                console.error("Error parsing premium augments:", e);
                return {
                    premiums: [],
                    totalPA: 0,
                    baseRate: 0,
                    bidSubmitted: 0,
                    baseRateTransformations: []
                };
            }
        }

        function normalizeDateString(input) {
            if (!input) return input;
            let str = String(input).trim();
            str = str.replace(/\s*(?:GMT|UTC|EST|EDT|CST|CDT|MST|MDT|PST|PDT|IST|BST|CET|CEST|JST|KST|AEST|AEDT|NZST|NZDT)\b/gi, '');
            str = str.replace(/\s*[+-]\d{2}:?\d{2}\b/g, '');
            str = str.replace(/Z$/i, '');
            str = str.trim();
            const m = str.match(
                /^\s*(\d{1,2})[.\-\/\s](\d{1,2})[.\-\/\s](\d{2,4})\s*(.*)$/
            );
            if (!m) return str;
            let [, mm, dd, y, rest] = m;
            let yyyy = y.length === 2 ? (parseInt(y, 10) <= 49 ? 2000 + +y : 1900 + +y) : +y;
            const pad = n => String(n).padStart(2, '0');
            const datePart = `${pad(mm)}/${pad(dd)}/${yyyy}`;
            let timePart = '';
            if (rest) {
                const t = rest.match(/^\s*[T ]?\s*(\d{1,2}:\d{2}(?::\d{2})?\s*(?:[APap][Mm])?)\s*/);
                if (t) timePart = t[1].replace(/\s+/g, ' ').trim();
            }
            return timePart ? `${datePart} ${timePart}` : datePart;
        }

        var app = (function () {
            let config = null;
            var dynamic_config = {
                "form_fields": [
                    {
                        "api_key": "shipper_code",
                        "default": "test",
                        "hidden": false,
                        "id": "shipper_code",
                        "label": "Shipper Code",
                        "placeholder": "Enter shipper code",
                        "required": true,
                        "type": "text"
                    },
                    {
                        "api_key": "load_id",
                        "default": "",
                        "id": "load_id",
                        "label": "Load ID",
                        "placeholder": "Enter load ID",
                        "required": true,
                        "type": "text"
                    },
                    {
                        "api_key": "pickup_date_time",
                        "id": "pickup_date",
                        "label": "Pickup Date",
                        "required": true,
                        "type": "datetime-local"
                    },
                    {
                        "api_key": "delivery_date_time",
                        "id": "drop_date",
                        "label": "Drop Date",
                        "required": true,
                        "type": "datetime-local"
                    },
                    {
                        "api_key": "equipment_type",
                        "default": "dryvan",
                        "id": "equipment_type",
                        "label": "Equipment",
                        "options": [
                            { "label": "Dryvan", "value": "dryvan" },
                            { "label": "Dryvan LTL", "value": "dry_ltl" },
                            { "label": "Dryvan IMDL", "value": "dry_imdl" },
                            { "label": "Reefer", "value": "reefer" },
                            { "label": "Reefer LTL", "value": "reefer_ltl" },
                            { "label": "Flatbed", "value": "flatbed" },
                            { "label": "Flatbed LTL", "value": "flat_ltl" },
                            { "label": "Conestoga", "value": "conestoga" },
                            { "label": "Tanker", "value": "tanker" },
                            { "label": "Step Deck", "value": "step_deck" },
                            { "label": "Box Truck", "value": "box_truck" },
                            { "label": "Parcel", "value": "parcel" },
                            { "label": "Power Only", "value": "power_only" },
                            { "label": "Goose Neck", "value": "goose_neck" },
                            { "label": "Double Drop", "value": "double_drop" },
                            { "label": "Curtainside", "value": "curtainside" },
                            { "label": "Sprinter Van", "value": "sprinter" },
                            { "label": "Hotshot", "value": "hotshot" },
                            { "label": "Dry Bulk", "value": "dry_bulk" },
                            { "label": "Wet Bulk", "value": "wet_bulk" },
                            { "label": "Container FCL", "value": "container_fcl" },
                            { "label": "Container LCL", "value": "container_lcl" },
                            { "label": "Dump Trailer", "value": "dump_trailer" },
                            { "label": "Maxi Trailer", "value": "maxi_trailer" },
                            { "label": "Trailer Pool Interchange", "value": "trailer_pool_interchange" }
                        ],
                        "required": true,
                        "type": "select"
                    },
                    {
                        "api_key": "distance_mi",
                        "default": "",
                        "id": "distance",
                        "label": "Distance (miles)",
                        "placeholder": "0",
                        "required": true,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "weight",
                        "default": "",
                        "id": "weight",
                        "label": "Weight (lbs)",
                        "placeholder": "45000",
                        "required": true,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "accessorials",
                        "default": [],
                        "id": "accessorials",
                        "label": "Accessorials",
                        "options": [
                            { "label": "Driver Assist", "value": "driver_assist" },
                            { "label": "Floor Loaded", "value": "floor_loaded" },
                            { "label": "Hazmat", "value": "hazmat" },
                            { "label": "Pallet Jack", "value": "pallet_jack" },
                            { "label": "Pallet Exchange", "value": "pallet_exchange" },
                            { "label": "Tanker Endorsement", "value": "tanker_endorsement" },
                            { "label": "Washout", "value": "washout" },
                            { "label": "Weight Ticket", "value": "weight_ticket" },
                            { "label": "Drop Trailer at Pickup", "value": "drop_trailer_at_pickup" },
                            { "label": "Drop Trailer at Delivery", "value": "drop_trailer_at_delivery" },
                            { "label": "Tarps 4ft", "value": "tarps_4ft" },
                            { "label": "Tarps 8ft", "value": "tarps_8ft" },
                            { "label": "Pipe Stakes", "value": "pipe_stakes" },
                            { "label": "Twic Card", "value": "twic_card" },
                            { "label": "Lift Gate", "value": "lift_gate" },
                            { "label": "PU Lift Gate", "value": "pu_lift_gate" },
                            { "label": "PU Residential", "value": "pu_residential" },
                            { "label": "Residential", "value": "residential" },
                            { "label": "Excessive Value Charge", "value": "high_cargo_value" },
                            { "label": "Other", "value": "other" }
                        ],
                        "required": false,
                        "type": "multiselect"
                    }
                ],
                "hidden_fields": [],
                "show_more_fields": [
                    {
                        "api_key": "commodity",
                        "default": "",
                        "id": "commodity",
                        "label": "Commodity",
                        "placeholder": "Commodity",
                        "required": false,
                        "type": "text"
                    },
                    {
                        "api_key": "pickup_window_hours",
                        "default": "24",
                        "id": "pickup_window_hours",
                        "label": "Pickup Window Hours",
                        "placeholder": "24",
                        "required": false,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "delivery_window_hours",
                        "default": "24",
                        "id": "delivery_window_hours",
                        "label": "Delivery Window Hours",
                        "placeholder": "24",
                        "required": false,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "min_temperature",
                        "default": "35",
                        "id": "min_temperature",
                        "label": "Min Temperature",
                        "placeholder": "35",
                        "required": false,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "max_temperature",
                        "default": "85",
                        "id": "max_temperature",
                        "label": "Max Temperature",
                        "placeholder": "85",
                        "required": false,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "cargo_value",
                        "default": "111",
                        "id": "cargo_value",
                        "label": "Cargo Value ($)",
                        "placeholder": "0.00",
                        "required": false,
                        "type": "text",
                        "attribute_number": true
                    },
                    {
                        "api_key": "transit_related_items",
                        "default": "",
                        "id": "transit_related_items",
                        "label": "Transit Related Items",
                        "options": [
                            { "label": "None", "value": "" },
                            { "label": "Team Driver", "value": "team_driver" },
                            { "label": "Insufficient Transit", "value": "insufficient_transit" },
                            { "label": "Excess Transit", "value": "excess_transit" }
                        ],
                        "required": false,
                        "type": "select"
                    }
                ],
                "third_party_extensions": {
                    "google_maps": {
                        "enabled": false,
                        "error_webhook_url": "https://your-error-webhook.com",
                        "google_maps_api_key": "YOUR_GOOGLE_MAPS_API_KEY",
                        "on_error_message": "Error message when google maps api key failed"
                    }
                }
            };
            let currentAccount = null;
            let avrls_creds = null;

            function renderStateOptions(countryCode, selectedState = null) {
                const stateSelect = document.getElementById('modal-state');
                stateSelect.innerHTML = '<option value="">Select State</option>';

                let regions = [];
                if (countryCode === 'US' || countryCode === 'USA') { // Handle both codes
                    regions = [...COUNTRY_REGION_MAP.USA.states, ...COUNTRY_REGION_MAP.USA.territories];
                } else if (countryCode === 'CA' || countryCode === 'Canada') {
                    regions = [...COUNTRY_REGION_MAP.CANADA.provinces, ...COUNTRY_REGION_MAP.CANADA.territories];
                }

                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.code;
                    option.textContent = `${region.name} (${region.code})`;
                    stateSelect.appendChild(option);
                });

                if (selectedState) {
                    stateSelect.value = selectedState;
                }
            }

            document.getElementById('modal-country').addEventListener('change', function () {
                renderStateOptions(this.value);
            });

            let currentLocationEditStopIndex = null;
            let stops = [
                { city: '', state: '', zip: '', country: 'US', type: 'live', label: 'Origin' },
                { city: '', state: '', zip: '', country: 'US', type: 'live', label: 'Destination' }
            ];

            function showLoading() {
                document.getElementById('loading-container').classList.remove('hide');
            }

            function hideLoading() {
                document.getElementById('loading-container').classList.add('hide');
            }

            function logout() {
                storageAPI.remove(['avrlinternal_consumer_creds', 'avrlglass_client_name'], function () {
                    storageAPI.redirect('login.html');
                });
            }

            function editLocation(index) {
                currentLocationEditStopIndex = index;
                const stop = stops[index];
                document.getElementById('modal-title').textContent = 'Edit ' + stop.label;
                const cityInput = document.getElementById('modal-city');
                const zipInput = document.getElementById('modal-zip');
                const countrySelect = document.getElementById('modal-country');
                cityInput.value = stop.city;
                zipInput.value = stop.zip;
                countrySelect.value = stop.country;

                // Render states based on country and select current state
                renderStateOptions(stop.country, stop.state);

                [cityInput, zipInput].forEach(function (input) {
                    if (input.value) {
                        input.closest('.input-field').classList.add('has-value');
                    }
                });
                if (config && config.third_party_extensions && config.third_party_extensions.google_maps["enabled"]) {
                    document.getElementById('zip-fetch-icon').classList.remove('hide');
                } else {
                    document.getElementById('zip-fetch-icon').classList.add('hide');
                }
                renderModalExtraFields(stop);
                document.getElementById('location-modal').classList.remove('hide');
            }

            function renderModalExtraFields(stop) {
                const extraFieldsContainer = document.getElementById('modal-extra-fields');
                const showMoreToggle = document.getElementById('show-more-toggle');
                extraFieldsContainer.innerHTML = '';
                extraFieldsContainer.classList.add('hide');
                showMoreToggle.classList.remove('expanded');
                if (!currentAccount || !currentAccount.location_modal_fields || currentAccount.location_modal_fields.length === 0) {
                    showMoreToggle.classList.add('hide');
                    return;
                }
                showMoreToggle.classList.remove('hide');
                currentAccount.location_modal_fields.forEach(function (field) {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'input-field';
                    let input;
                    if (field.type === 'select' && field.options) {
                        input = document.createElement('select');
                        field.options.forEach(function (opt) {
                            const option = document.createElement('option');
                            option.value = opt.value || opt;
                            option.textContent = opt.label || opt;
                            input.appendChild(option);
                        });
                    } else if (field.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.rows = 2;
                    } else {
                        input = document.createElement('input');
                        input.type = field.type || 'text';
                        input.placeholder = ' ';
                    }
                    input.id = 'modal-extra-' + field.id;
                    input.name = field.id;
                    input.autocomplete = 'off';
                    if (stop[field.id] !== undefined) {
                        input.value = stop[field.id];
                        fieldDiv.classList.add('has-value');
                    } else if (field.default) {
                        input.value = field.default;
                        fieldDiv.classList.add('has-value');
                    }
                    if (field.placeholder && input.placeholder !== ' ') {
                        input.placeholder = field.placeholder;
                    }
                    input.addEventListener('input', function () {
                        if (this.value) {
                            fieldDiv.classList.add('has-value');
                        } else {
                            fieldDiv.classList.remove('has-value');
                        }
                    });
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    if (field.required) label.classList.add('required');
                    fieldDiv.appendChild(input);
                    fieldDiv.appendChild(label);
                    extraFieldsContainer.appendChild(fieldDiv);
                });
            }

            function toggleExtraFields() {
                const extraFieldsContainer = document.getElementById('modal-extra-fields');
                const showMoreToggle = document.getElementById('show-more-toggle');
                const toggleText = showMoreToggle.querySelector('span');
                if (extraFieldsContainer.classList.contains('hide')) {
                    extraFieldsContainer.classList.remove('hide');
                    showMoreToggle.classList.add('expanded');
                    toggleText.textContent = 'Show Less';
                } else {
                    extraFieldsContainer.classList.add('hide');
                    showMoreToggle.classList.remove('expanded');
                    toggleText.textContent = 'Show More';
                }
            }

            function closeLocationModal() {
                document.getElementById('location-modal').classList.add('hide');
                currentLocationEditStopIndex = null;
            }

            function saveLocation() {
                if (currentLocationEditStopIndex === null) return;
                const city = document.getElementById('modal-city').value.trim();
                const state = document.getElementById('modal-state').value.trim().toUpperCase();
                const zip = document.getElementById('modal-zip').value.trim();
                const country = document.getElementById('modal-country').value;
                if (!city || !state || !zip) {
                    showToast('Please fill all fields', 2000);
                    return;
                }
                stops[currentLocationEditStopIndex].city = city;
                stops[currentLocationEditStopIndex].state = state;
                stops[currentLocationEditStopIndex].zip = zip;
                stops[currentLocationEditStopIndex].country = country;
                if (currentAccount && currentAccount.location_modal_fields) {
                    currentAccount.location_modal_fields.forEach(function (field) {
                        const input = document.getElementById('modal-extra-' + field.id);
                        if (input) {
                            stops[currentLocationEditStopIndex][field.id] = input.value;
                        }
                    });
                }
                renderStops();
                closeLocationModal();
            }

            function fetchFromZip() {
                const zip = document.getElementById('modal-zip').value.trim();
                if (!zip) {
                    showToast('Please enter ZIP code', 2000);
                    return;
                }
                showLoading();
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://clienttools2.avrlgeneration.com/search_by_zip', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        hideLoading();
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.status === 'ok') {
                                    document.getElementById('modal-city').value = response.city || '';
                                    document.getElementById('modal-state').value = response.state || '';
                                    const countrySelect = document.getElementById('modal-country');
                                    if (response.country === 'USA') {
                                        countrySelect.value = 'US';
                                    } else if (response.country === 'Canada') {
                                        countrySelect.value = 'CA';
                                    } else {
                                        countrySelect.value = 'US';
                                    }
                                    ['modal-city', 'modal-state'].forEach(function (id) {
                                        const input = document.getElementById(id);
                                        if (input && input.value) {
                                            input.closest('.input-field').classList.add('has-value');
                                        }
                                    });
                                    showToast('Location details fetched successfully', 2000);
                                } else {
                                    showToast('ZIP code not found', 2000);
                                }
                            } catch (e) {
                                showToast('Failed to parse response', 2000);
                            }
                        } else {
                            showToast('Failed to fetch location details', 2000);
                        }
                    }
                };
                xhr.send(JSON.stringify({ zipcode: zip }));
            }

            function addStop() {
                if (!config || !config.features || !config.features.multi_stops) return;
                const newStop = {
                    city: '',
                    state: '',
                    zip: '',
                    country: 'US',
                    type: 'live',
                    label: 'Stop ' + (stops.length - 1)
                };
                stops.splice(stops.length - 1, 0, newStop);
                renderStops();
            }

            function deleteStop(index) {
                if (stops.length <= 2) return;
                if (index === 0 || index === stops.length - 1) return;
                stops.splice(index, 1);
                for (let i = 1; i < stops.length - 1; i++) {
                    stops[i].label = 'Stop ' + i;
                }
                renderStops();
            }

            function toggleStopType(index) {
                stops[index].type = stops[index].type === 'live' ? 'drop' : 'live';
            }

            function renderStops() {
                const container = document.getElementById('stops-container');
                container.innerHTML = '';
                const stopsGrid = document.createElement('div');
                stopsGrid.id = 'stops-grid';
                console.log("stopsss", stops);
                stops.forEach(function (stop, index) {
                    const stopDiv = document.createElement('div');
                    stopDiv.className = 'stop-item';
                    const header = document.createElement('div');
                    header.className = 'stop-header';
                    const label = document.createElement('span');
                    label.className = 'stop-label' + (index === 0 || index === stops.length - 1 ? ' required' : '');
                    label.textContent = stop.label;
                    header.appendChild(label);
                    const controls = document.createElement('div');
                    controls.className = 'stop-controls';
                    const toggleId = 'toggle-' + index;
                    const toggleInput = document.createElement('input');
                    toggleInput.type = 'checkbox';
                    toggleInput.className = 'toggle-switch';
                    toggleInput.id = toggleId;
                    toggleInput.checked = stop.type === 'drop';
                    toggleInput.addEventListener('change', function () {
                        toggleStopType(index);
                    });
                    const toggleLabel = document.createElement('label');
                    toggleLabel.className = 'toggle-label';
                    toggleLabel.setAttribute('for', toggleId);
                    toggleLabel.innerHTML = '<span>Live</span><span>Drop</span>';
                    controls.appendChild(toggleInput);
                    controls.appendChild(toggleLabel);
                    if (index !== 0 && index !== stops.length - 1) {
                        const deleteIcon = document.createElement('i');
                        deleteIcon.className = 'fa-solid fa-trash delete-stop';
                        deleteIcon.onclick = function () { deleteStop(index); };
                        controls.appendChild(deleteIcon);
                    }
                    header.appendChild(controls);
                    stopDiv.appendChild(header);
                    const zipContainer = document.createElement('div');
                    zipContainer.className = 'stop-zip-container';
                    const zipInputField = document.createElement('div');
                    zipInputField.className = 'input-field stop-zip-field';
                    const zipInput = document.createElement('input');
                    zipInput.type = 'text';
                    zipInput.placeholder = ' ';
                    zipInput.maxLength = 10;
                    zipInput.autocomplete = 'off';
                    zipInput.setAttribute('autocomplete', 'new-password');
                    zipInput.setAttribute('data-form-type', 'other');
                    zipInput.setAttribute('data-lpignore', 'true');
                    zipInput.setAttribute('data-1p-ignore', 'true');
                    zipInput.id = 'stop-zip-' + index;
                    zipInput.value = stop.zip || '';
                    if (!stop._lastFetchedZip) stop._lastFetchedZip = '';
                    if (!stop._isFetching) stop._isFetching = false;
                    zipInput._lastFetchedZip = stop._lastFetchedZip;
                    zipInput._isFetching = stop._isFetching;
                    // zipInput.addEventListener('input', function () {
                    //     const trimmedValue = this.value.trim();
                    //     stop.zip = trimmedValue;

                    //     if (this.value) {
                    //         zipInputField.classList.add('has-value');
                    //     } else {
                    //         zipInputField.classList.remove('has-value');
                    //     }

                    //     // STRICT REGEX VALIDATION
                    //     const usZipRegex = /^\d{5}$/;
                    //     const caZipRegex = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/;

                    //     const isUsZip = usZipRegex.test(trimmedValue);
                    //     const isCaZip = caZipRegex.test(trimmedValue);

                    //     if ((isUsZip || isCaZip) && trimmedValue !== stop._lastFetchedZip && !stop._isFetching) {
                    //         stop._lastFetchedZip = trimmedValue;
                    //         this._lastFetchedZip = trimmedValue;
                    //         stop._isFetching = true;
                    //         this._isFetching = true;

                    //         fetchStopFromZip(index, function (success) {
                    //             stop._isFetching = false;
                    //             if (zipInput) zipInput._isFetching = false;
                    //         });
                    //     }
                    // });

                    zipInput.addEventListener('input', function () {
                        const trimmedValue = this.value.trim();
                        stop.zip = trimmedValue;

                        if (this.value) {
                            zipInputField.classList.add('has-value');
                        } else {
                            zipInputField.classList.remove('has-value');
                        }

                        // STRICT REGEX VALIDATION
                        const usZipRegex = /^\d{5}$/;
                        const caZipRegex = /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/;
                        const isUsZip = usZipRegex.test(trimmedValue);
                        const isCaZip = caZipRegex.test(trimmedValue);

                        // Fetch every time if valid ZIP format (no caching)
                        if (isUsZip || isCaZip) {
                            fetchStopFromZip(index, function (success) {
                                // Callback after fetch completes (optional)
                            });
                        }
                    });

                    if (stop.zip) {
                        zipInputField.classList.add('has-value');
                    }
                    const zipLabel = document.createElement('label');
                    zipLabel.textContent = 'ZIP';
                    if (index === 0 || index === stops.length - 1) {
                        zipLabel.classList.add('required');
                    }
                    zipInputField.appendChild(zipInput);
                    zipInputField.appendChild(zipLabel);
                    zipContainer.appendChild(zipInputField);
                    const locationText = document.createElement('div');
                    locationText.className = 'stop-location-text';
                    const locationTextSpan = document.createElement('span');
                    locationTextSpan.id = 'stop-location-text-' + index;
                    console.log("sdfds", stop)
                    if (stop.city || stop.state) {
                        const parts = [];
                        if (stop.city) parts.push(stop.city);
                        if (stop.state) parts.push(stop.state);
                        if (stop.country) parts.push(stop.country);
                        console.log("sfdsfsfsddf", parts.join(', '))
                        locationTextSpan.textContent = parts.join(', ');
                    } else {
                        locationTextSpan.textContent = 'Enter ZIP & fetch';
                        locationText.classList.add('placeholder');
                    }
                    const editIcon = document.createElement('i');
                    editIcon.className = 'fa-solid fa-pen stop-location-edit-icon';
                    editIcon.title = 'Edit location';
                    editIcon.onclick = function () { editLocation(index); };
                    locationText.appendChild(locationTextSpan);
                    locationText.appendChild(editIcon);
                    zipContainer.appendChild(locationText);
                    stopDiv.appendChild(zipContainer);
                    stopsGrid.appendChild(stopDiv);
                });
                container.appendChild(stopsGrid);
                const addStopBtn = document.createElement('button');
                addStopBtn.id = 'add-stop-btn';
                addStopBtn.className = '';
                addStopBtn.title = 'Add Stop';
                addStopBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
                addStopBtn.addEventListener('click', addStop);
                container.appendChild(addStopBtn);
                selectedTextFiller.enableForAllInputs();
            }

            window.fetchStopFromZip = function fetchStopFromZip(index, callback) {
                const stop = stops[index];
                const zipInput = document.getElementById('stop-zip-' + index);
                const zip = zipInput ? zipInput.value.trim() : stop.zip;
                if (!zip) {
                    showToast('Please enter ZIP code', 2000);
                    if (callback) callback(false);
                    return;
                }
                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://clienttools2.avrlgeneration.com/search_by_zip', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        let success = false;
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.status === 'ok') {
                                    stop.city = response.city || '';
                                    stop.state = response.state || '';
                                    if (response.country === 'USA') {
                                        stop.country = 'US';
                                    } else if (response.country === 'Canada') {
                                        stop.country = 'CA'; // Ensure your backend returns 'Canada' or handled code
                                    } else {
                                        stop.country = 'US';
                                    }

                                    // We successfully got data
                                    success = true;
                                    showToast(' Location: ' + (stop.city || '') + ', ' + (stop.state || ''), 1500);

                                } else {
                                    // Response status not ok
                                    showToast('ZIP code not found', 2000);
                                    success = false;
                                }
                            } catch (e) {
                                console.error('Error parsing ZIP response:', e);
                                showToast('Failed to parse response', 2000);
                                success = false;
                            }
                        } else {
                            showToast('Failed to fetch location details', 2000);
                            success = false;
                        }

                        // === UPDATE UI & CALLBACK ===
                        if (!success) {
                            // CLEAR FIELDS ON FAILURE
                            stop.city = '';
                            stop.state = '';
                            // Optional: stop.country = 'US'; // Keep previous or reset? Let's reset to default US
                            // stop.country = 'US';
                        }

                        const locationTextSpan = document.getElementById('stop-location-text-' + index);
                        if (locationTextSpan) {
                            const parts = [];
                            if (stop.city) parts.push(stop.city);
                            if (stop.state) parts.push(stop.state);
                            if (stop.country) parts.push(stop.country)

                            const locationTextDiv = locationTextSpan.parentElement;

                            if (parts.length > 0) {
                                locationTextSpan.textContent = parts.join(', ');
                                if (locationTextDiv) {
                                    locationTextDiv.style.display = 'block'; // Ensure visible
                                    locationTextDiv.classList.remove('placeholder');
                                }
                            } else {
                                // Show placeholder
                                locationTextSpan.textContent = 'Enter ZIP & fetch';
                                if (locationTextDiv) {
                                    locationTextDiv.classList.add('placeholder');
                                }
                            }
                        }

                        if (callback) callback(success);
                    }
                };
                xhr.send(JSON.stringify({ zipcode: zip }));
            };

            function fetchDistanceFromGoogle() {
                if (config && config.third_party_extensions && config.third_party_extensions.google_maps["enabled"]) {
                } else {
                    return
                }
                const origin = stops[0];
                const destination = stops[stops.length - 1];
                if (!origin.zip || !destination.zip) {
                    showToast('Please add origin and destination first', 2000);
                    return;
                }
                console.log('Fetching distance from Google Maps');
                console.log('Origin:', origin.zip);
                console.log('Destination:', destination.zip);
                showToast('Google Maps Distance API - Coming soon!', 2000);
            }

            function handleAVRLSSignIn(account, callback) {
                const form_data = new URLSearchParams();
                form_data.append('grant_type', 'client_credentials');
                form_data.append('client_id', "prod1");
                form_data.append('client_secret', "prodpassword");
                showLoading();
                const xhr = new XMLHttpRequest();
                xhr.open('POST', `https://hypery.1avrl.com/oauth2_access_token/${config.client_name}/avrls`, true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        hideLoading();
                        if (xhr.status === 200) {
                            const resp = JSON.parse(xhr.responseText);
                            const storageKey = 'avrlinternal_avrls_creds_' + account.account;
                            avrls_creds = resp;
                            let storageData = {};
                            storageData[storageKey] = resp;
                            storageAPI.set(storageData, function () {
                                console.log('AVRLS Sign In Successful - Token refreshed');
                                if (callback) callback(true);
                            });
                        } else {
                            console.error('AVRLS Sign In Failed - Status:', xhr.status, 'Response:', xhr.responseText);
                            let errorMessage = 'Authentication failed (Status: ' + xhr.status + ')';
                            try {
                                if (xhr.responseText) {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.message) {
                                        errorMessage = errorResponse.message;
                                    } else if (errorResponse.error) {
                                        errorMessage = errorResponse.error;
                                    } else if (errorResponse.error_description) {
                                        errorMessage = errorResponse.error_description;
                                    }
                                }
                            } catch (e) { }
                            showToast('Auth Error: ' + errorMessage, 4000);
                            if (callback) callback(false);
                        }
                    }
                };
                xhr.send(form_data.toString());
            }

            function renderAccountSelector() {
                const container = document.getElementById('account-selector-container');
                console.log(config.accounts.length)
                if (!config || !config.accounts || config.accounts.length <= 1) {
                    container.classList.add('hide');
                    if (config && config.accounts && config.accounts.length === 1) {
                        currentAccount = config.accounts[0];
                        renderForm(currentAccount);
                    }
                    return;
                }
                const selector = document.getElementById('account-selector');
                selector.innerHTML = '';
                config.accounts.forEach(function (account, index) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = account.account_name;
                    selector.appendChild(option);
                });
                container.classList.remove('hide');
                currentAccount = config.accounts[0];
                renderForm(currentAccount);
                initAccountOAuth(currentAccount);
                selector.addEventListener('change', function () {
                    currentAccount = config.accounts[this.value];
                    renderForm(currentAccount);
                    initAccountOAuth(currentAccount);
                });
            }

            function initAccountOAuth(account) {
                const storageKey = 'avrlinternal_avrls_creds_' + account.account;
                console.log(storageKey)
                storageAPI.get([storageKey], function (result) {
                    console.log("wfsdfdsfds", result)
                    if (!result[storageKey]) {
                        console.log("login")
                        handleAVRLSSignIn(account);
                    } else if (result[storageKey]) {
                        avrls_creds = result[storageKey];
                        console.log('Using existing AVRLS credentials');
                    }
                });
            }

            function renderForm(account) {
                console.log("accounts", account);
                const form = document.getElementById('dynamic-form')
                if (!account || !account.form_fields) return;
                renderStops();
                const fragment = document.createDocumentFragment();
                const fields = account.form_fields;
                const visibleFields = fields.filter(function (field) {
                    return !field.hidden;
                });
                for (let i = 0; i < visibleFields.length; i += 2) {
                    const row = document.createElement('div');
                    row.className = 'input-row';
                    const field1 = visibleFields[i];
                    row.appendChild(createInputField(field1));
                    if (i + 1 < visibleFields.length) {
                        const field2 = visibleFields[i + 1];
                        row.appendChild(createInputField(field2));
                    }
                    fragment.appendChild(row);
                }
                form.innerHTML = '';
                form.appendChild(fragment);
                renderFormExtraFields(account);
                selectedTextFiller.enableForAllInputs();
            }

            function renderFormExtraFields(account) {
                const extraFieldsContainer = document.getElementById('form-extra-fields');
                const showMoreToggle = document.getElementById('form-show-more-toggle');
                extraFieldsContainer.innerHTML = '';
                extraFieldsContainer.classList.add('hide');
                showMoreToggle.classList.remove('expanded');
                if (!account || !account.show_more_fields || account.show_more_fields.length === 0) {
                    showMoreToggle.classList.add('hide');
                    return;
                }
                showMoreToggle.classList.remove('hide');
                const fragment = document.createDocumentFragment();
                const extraFields = account.show_more_fields;
                for (let i = 0; i < extraFields.length; i += 2) {
                    const row = document.createElement('div');
                    row.className = 'input-row';
                    const field1 = extraFields[i];
                    row.appendChild(createInputField(field1));
                    if (i + 1 < extraFields.length) {
                        const field2 = extraFields[i + 1];
                        row.appendChild(createInputField(field2));
                    }
                    fragment.appendChild(row);
                }
                extraFieldsContainer.appendChild(fragment);
            }

            function toggleFormExtraFields() {
                const extraFieldsContainer = document.getElementById('form-extra-fields');
                const showMoreToggle = document.getElementById('form-show-more-toggle');
                const toggleText = showMoreToggle.querySelector('span');
                if (extraFieldsContainer.classList.contains('hide')) {
                    extraFieldsContainer.classList.remove('hide');
                    showMoreToggle.classList.add('expanded');
                    toggleText.textContent = 'Show Less';
                } else {
                    extraFieldsContainer.classList.add('hide');
                    showMoreToggle.classList.remove('expanded');
                    toggleText.textContent = 'Show More';
                }
            }

            function getFieldApiKey(fieldId) {
                if (!currentAccount) return fieldId;
                if (currentAccount.form_fields) {
                    const formField = currentAccount.form_fields.find(f => f.id === fieldId);
                    if (formField && formField.api_key) {
                        return formField.api_key;
                    }
                }
                if (currentAccount.show_more_fields) {
                    const showMoreField = currentAccount.show_more_fields.find(f => f.id === fieldId);
                    if (showMoreField && showMoreField.api_key) {
                        return showMoreField.api_key;
                    }
                }
                if (currentAccount.hidden_fields) {
                    const hiddenField = currentAccount.hidden_fields.find(f => f.id === fieldId);
                    if (hiddenField && hiddenField.api_key) {
                        return hiddenField.api_key;
                    }
                }
                return fieldId;
            }

            function createSearchableSelect(field, isMultiSelect) {
                const container = document.createElement('div');
                container.className = 'searchable-select-container' + (isMultiSelect ? ' multiselect' : '');
                container.setAttribute('data-field-id', field.id);
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.className = 'searchable-select-input';
                searchInput.placeholder = ' '; // Use space placeholder for floating label compatibility
                searchInput.setAttribute('data-placeholder', isMultiSelect ? 'Click to See Options' : (field.placeholder || 'Select...'));
                searchInput.autocomplete = 'off';
                searchInput.id = field.id;
                searchInput.name = field.id;
                const dropdown = document.createElement('div');
                dropdown.className = 'searchable-select-dropdown hide';
                let selectedValues = [];
                if (field.default) {
                    selectedValues = Array.isArray(field.default) ? field.default : [field.default];
                }
                const options = field.options || [];
                const optionElements = [];
                options.forEach(function (opt) {
                    const optValue = opt.value || opt;
                    const optLabel = opt.label || opt;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'searchable-select-option';
                    optionDiv.setAttribute('data-value', optValue);
                    if (isMultiSelect) {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.setAttribute("not_include", true);
                        checkbox.value = optValue;
                        checkbox.checked = selectedValues.includes(optValue);
                        checkbox.id = 'opt_' + field.id + '_' + optValue.replace(/\s+/g, '_');
                        const labelText = document.createElement('span');
                        labelText.textContent = optLabel;
                        optionDiv.appendChild(checkbox);
                        optionDiv.appendChild(labelText);
                        optionDiv.addEventListener('click', function (e) {
                            if (e.target !== checkbox) {
                                checkbox.checked = !checkbox.checked;
                            }
                            if (checkbox.checked) {
                                if (!selectedValues.includes(optValue)) {
                                    selectedValues.push(optValue);
                                }
                            } else {
                                selectedValues = selectedValues.filter(v => v !== optValue);
                            }
                            updateSearchInput();
                        });
                    } else {
                        optionDiv.textContent = optLabel;
                        optionDiv.addEventListener('click', function () {
                            selectedValues = [optValue];
                            searchInput.value = optLabel;
                            dropdown.classList.add('hide');
                            updateSearchInput();
                        });
                    }
                    dropdown.appendChild(optionDiv);
                    optionElements.push({ element: optionDiv, value: optValue, label: optLabel });
                });

                function updateSearchInput() {
                    if (isMultiSelect) {
                        if (selectedValues.length > 0) {
                            const selectedLabels = selectedValues.map(function (val) {
                                const opt = options.find(o => (o.value || o) === val);
                                return opt ? (opt.label || opt) : val;
                            });
                            searchInput.value = selectedLabels.join(', ');
                        } else {
                            searchInput.value = '';
                        }
                    } else {
                        if (selectedValues.length > 0) {
                            const opt = options.find(o => (o.value || o) === selectedValues[0]);
                            searchInput.value = opt ? (opt.label || opt) : selectedValues[0];
                        } else {
                            searchInput.value = '';
                        }
                    }
                    const fieldDiv = container.closest('.input-field');
                    if (fieldDiv) {
                        if (selectedValues.length > 0) {
                            fieldDiv.classList.add('has-value');
                        } else {
                            fieldDiv.classList.remove('has-value');
                        }
                    }
                }

                updateSearchInput();
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase().trim();
                    if (isMultiSelect && searchTerm) {
                        optionElements.forEach(function (opt) {
                            if (opt.label.toLowerCase().includes(searchTerm)) {
                                opt.element.classList.remove('hide');
                            } else {
                                opt.element.classList.add('hide');
                            }
                        });
                    } else if (!isMultiSelect) {
                        optionElements.forEach(function (opt) {
                            if (opt.label.toLowerCase().includes(searchTerm)) {
                                opt.element.classList.remove('hide');
                            } else {
                                opt.element.classList.add('hide');
                            }
                        });
                    }
                });
                searchInput.addEventListener('focus', function () {
                    dropdown.classList.remove('hide');
                    optionElements.forEach(opt => opt.element.classList.remove('hide'));
                });
                if (isMultiSelect) {
                    searchInput.addEventListener('focus', function () {
                        const currentValue = this.value;
                        this.setAttribute('data-display-value', currentValue);
                        this.value = '';
                    });
                    searchInput.addEventListener('blur', function () {
                        setTimeout(() => {
                            updateSearchInput();
                            dropdown.classList.add('hide');
                        }, 200);
                    });
                }
                
                // Click outside to close dropdown (use event capturing to handle properly)
                const handleClickOutside = function (e) {
                    if (!container.contains(e.target)) {
                        dropdown.classList.add('hide');
                        if (isMultiSelect) {
                            updateSearchInput();
                        }
                    }
                };
                
                // Remove listener when dropdown closes to prevent memory leaks
                searchInput.addEventListener('focus', function() {
                    document.addEventListener('click', handleClickOutside, true);
                });
                
                searchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        document.removeEventListener('click', handleClickOutside, true);
                    }, 250);
                });
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = field.id + '_value';
                hiddenInput.name = field.id + '_value';
                hiddenInput.value = isMultiSelect ? JSON.stringify(selectedValues) : (selectedValues[0] || '');
                const originalUpdateSearchInput = updateSearchInput;
                updateSearchInput = function () {
                    originalUpdateSearchInput();
                    hiddenInput.value = isMultiSelect ? JSON.stringify(selectedValues) : (selectedValues[0] || '');
                };
                container.appendChild(searchInput);
                container.appendChild(dropdown);
                container.appendChild(hiddenInput);
                container.getSelectedValues = function () {
                    return isMultiSelect ? selectedValues : (selectedValues[0] || '');
                };
                return container;
            }

            function createInputField(field) {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'input-field';
                const isDistanceField = field.id === 'distance';
                const hasGoogleMaps = config && config.third_party_extensions && config.third_party_extensions.google_maps["enabled"];
                const isDateTimeField = field.type === 'datetime-local' || field.id === 'pickup_date' || field.id === 'drop_date';
                let inputWrapper;
                if ((isDistanceField && hasGoogleMaps) || isDateTimeField) {
                    inputWrapper = document.createElement('div');
                    inputWrapper.className = 'input-with-icon';
                } else {
                    inputWrapper = fieldDiv;
                }
                let input;
                if (field.type === 'select') {
                    input = createSearchableSelect(field, false);
                } else if (field.type === 'multiselect') {
                    input = createSearchableSelect(field, true);
                } else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 2;
                } else if (isDateTimeField) {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.setAttribute('data-datetime', 'true');
                    input.setAttribute("default", field.default)
                    input.placeholder = ' ';
                    let sanitizeTimer;

                    function stripTimezone(str) {
                        return str
                            .replace(/\b([A-Z]{2,4})\b/g, "")
                            .replace(/([+-]\d{2}:?\d{2}|\bZ\b)/gi, "")
                            .trim()
                            .replace(/\s\s+/g, " ");
                    }

                    // function parseCustomDateTime(dateString) {
                    //     if (!dateString || typeof dateString !== 'string') {
                    //         return null;
                    //     }

                    //     const input = dateString.trim();
                    //     const now = new Date();
                    //     const currentYear = now.getFullYear();

                    //     // Default time: 9:00 AM EST
                    //     const defaultHour = 9;
                    //     const defaultMinute = 0;
                    //     const defaultSecond = 0;

                    //     // Month mapping
                    //     const monthMap = {
                    //         jan: 1, january: 1,
                    //         feb: 2, february: 2,
                    //         mar: 3, march: 3,
                    //         apr: 4, april: 4,
                    //         may: 5,
                    //         jun: 6, june: 6,
                    //         jul: 7, july: 7,
                    //         aug: 8, august: 8,
                    //         sep: 9, sept: 9, september: 9,
                    //         oct: 10, october: 10,
                    //         nov: 11, november: 11,
                    //         dec: 12, december: 12
                    //     };

                    //     // Helper: Parse month (digit or name)
                    //     const parseMonth = (m) => {
                    //         if (/^\d+$/.test(m)) {
                    //             const num = parseInt(m);
                    //             return (num >= 1 && num <= 12) ? num : null;
                    //         }
                    //         const lower = m.toLowerCase();
                    //         return monthMap[lower] || null;
                    //     };

                    //     // Helper: Convert 12-hour to 24-hour format
                    //     const convert12to24 = (hour, isPM) => {
                    //         hour = parseInt(hour);
                    //         if (isPM && hour !== 12) return hour + 12;
                    //         if (!isPM && hour === 12) return 0;
                    //         return hour;
                    //     };

                    //     // Helper: Create date with time (or default 9 AM EST)
                    //     const createDate = (y, m, d, h = defaultHour, min = defaultMinute, s = defaultSecond) => {
                    //         const date = new Date(y, m - 1, d, h, min, s);
                    //         if (isNaN(date.getTime())) return null;
                    //         return date;
                    //     };

                    //     // Separator pattern: space, comma, hyphen, forward-slash, backslash
                    //     const sep = '[\\s,\\-/\\\\]+';

                    //     // Pattern for month or day (digit 1-2 chars OR month name)
                    //     const monthOrDay = '(\\d{1,2}|[a-zA-Z]+)';
                    //     const day = '(\\d{1,2})';
                    //     const year2or4 = '(\\d{2,4})';

                    //     // Time pattern: HH:MM or HH:MM:SS with optional AM/PM
                    //     const timePattern = '(?:[\\s,]+)?(\\d{1,2}):(\\d{1,2})(?::(\\d{1,2}))?\\s*(am|pm)?';

                    //     // Pattern 1: YYYY MM DD [TIME] (year first)
                    //     let match = input.match(new RegExp(`^${year2or4}${sep}${monthOrDay}${sep}${day}(?:${timePattern})?$`, 'i'));
                    //     if (match) {
                    //         let y = parseInt(match[1]);
                    //         if (y < 100) y += y < 50 ? 2000 : 1900;
                    //         const m = parseMonth(match[2]);
                    //         const d = parseInt(match[3]);

                    //         // Parse time if present
                    //         let h = defaultHour, min = defaultMinute, s = defaultSecond;
                    //         if (match[4]) {
                    //             h = parseInt(match[4]);
                    //             min = parseInt(match[5]);
                    //             s = match[6] ? parseInt(match[6]) : 0;
                    //             const ampm = match[7] ? match[7].toLowerCase() : null;
                    //             if (ampm) {
                    //                 h = convert12to24(h, ampm === 'pm');
                    //             }
                    //         }

                    //         if (m) return createDate(y, m, d, h, min, s);
                    //     }

                    //     // Pattern 2: MM DD YYYY [TIME] (US format)
                    //     match = input.match(new RegExp(`^${monthOrDay}${sep}${day}${sep}${year2or4}(?:${timePattern})?$`, 'i'));
                    //     if (match) {
                    //         const m = parseMonth(match[1]);
                    //         const d = parseInt(match[2]);
                    //         let y = parseInt(match[3]);
                    //         if (y < 100) y += y < 50 ? 2000 : 1900;

                    //         // Parse time if present
                    //         let h = defaultHour, min = defaultMinute, s = defaultSecond;
                    //         if (match[4]) {
                    //             h = parseInt(match[4]);
                    //             min = parseInt(match[5]);
                    //             s = match[6] ? parseInt(match[6]) : 0;
                    //             const ampm = match[7] ? match[7].toLowerCase() : null;
                    //             if (ampm) {
                    //                 h = convert12to24(h, ampm === 'pm');
                    //             }
                    //         }

                    //         if (m) return createDate(y, m, d, h, min, s);
                    //     }

                    //     // Pattern 3: MM DD [TIME] (no year, use current year)
                    //     match = input.match(new RegExp(`^${monthOrDay}${sep}${day}(?:${timePattern})?$`, 'i'));
                    //     if (match) {
                    //         const m = parseMonth(match[1]);
                    //         const d = parseInt(match[2]);

                    //         // Parse time if present
                    //         let h = defaultHour, min = defaultMinute, s = defaultSecond;
                    //         if (match[3]) {
                    //             h = parseInt(match[3]);
                    //             min = parseInt(match[4]);
                    //             s = match[5] ? parseInt(match[5]) : 0;
                    //             const ampm = match[6] ? match[6].toLowerCase() : null;
                    //             if (ampm) {
                    //                 h = convert12to24(h, ampm === 'pm');
                    //             }
                    //         }

                    //         if (m) return createDate(currentYear, m, d, h, min, s);
                    //     }

                    //     return null;
                    // }
                    function parseCustomDateTime(inputString) {
                        if (!inputString || typeof inputString !== "string") return null;

                        // ===============================
                        // 1. Normalize browser junk
                        // ===============================
                        let input = inputString
                            .trim()
                            .normalize("NFKD")
                            .replace(/[^\S\r\n]/g, " ")              // all unicode spaces  space
                            .replace(/[]/g, "-")                   // long dashes
                            .replace(/\b(UTC|GMT|EST|EDT|CST|CDT|MST|MDT|PST|PDT|IST|BST|CET|CEST|JST|AEST|AEDT)\b/gi, "")
                            .replace(/(\d)(am|pm)\b/gi, "$1 $2")     // 05:00PM  05:00 PM

                            //  FIX: trim anything AFTER AM/PM dash (Dec 15, 08:00 AM - ...)
                            .replace(/\b(am|pm)\b\s*-\s*.*$/i, "$1")

                            // drop generic ranges (still needed)
                            .replace(/\s*-\s*.+$/, "")
                            .replace(/,/g, " ")
                            .replace(/\s+/g, " ")
                            .trim();

                        const now = new Date();

                        // ===============================
                        // 2. TIME ONLY (EARLY RETURN)
                        // ===============================
                        let m = input.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(am|pm)?$/i);
                        if (m) {
                            let h = +m[1];
                            const min = +m[2];
                            const sec = m[3] ? +m[3] : 0;
                            const ap = m[4]?.toLowerCase() || null;

                            if (ap === "pm" && h !== 12) h += 12;
                            if (ap === "am" && h === 12) h = 0;

                            return {
                                year: now.getFullYear(),
                                month: now.getMonth() + 1,
                                day: now.getDate(),
                                hour24: h,
                                hour12: ((h + 11) % 12) + 1,
                                minute: min,
                                second: sec,
                                ampm: ap,

                                display12h: `${((h + 11) % 12) + 1}:${String(min).padStart(2, "0")} ${h >= 12 ? "PM" : "AM"}`,
                                display24h: `${String(h).padStart(2, "0")}:${String(min).padStart(2, "0")}`,

                                isoLocal:
                                    `${now.getFullYear()}-` +
                                    `${String(now.getMonth() + 1).padStart(2, "0")}-` +
                                    `${String(now.getDate()).padStart(2, "0")}T` +
                                    `${String(h).padStart(2, "0")}:${String(min).padStart(2, "0")}:${String(sec).padStart(2, "0")}`,

                                isTimeOnly: true
                            };
                        }

                        // ===============================
                        // 3. Defaults
                        // ===============================
                        let year = now.getFullYear();
                        let month = null;
                        let day = null;

                        let hour = 9;   // default time
                        let minute = 0;
                        let second = 0;
                        let ampm = "am";

                        const monthMap = {
                            jan: 1, january: 1,
                            feb: 2, february: 2,
                            mar: 3, march: 3,
                            apr: 4, april: 4,
                            may: 5,
                            jun: 6, june: 6,
                            jul: 7, july: 7,
                            aug: 8, august: 8,
                            sep: 9, sept: 9, september: 9,
                            oct: 10, october: 10,
                            nov: 11, november: 11,
                            dec: 12, december: 12
                        };

                        const parseMonth = (m) =>
                            /^\d+$/.test(m)
                                ? (+m >= 1 && +m <= 12 ? +m : null)
                                : monthMap[m.toLowerCase()] || null;

                        const normalizeYear = (y) => {
                            if (y < 100) {
                                const base = Math.floor(now.getFullYear() / 100) * 100;
                                y += base;
                                if (y > now.getFullYear() + 20) y -= 100;
                            }
                            return y;
                        };

                        // ===============================
                        // 4. YYYY MM DD [TIME]
                        // ===============================
                        m = input.match(
                            /^(\d{2,4})[\/\-\s\\]+(\d{1,2}|[a-zA-Z]+)[\/\-\s\\]+(\d{1,2})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(am|pm)?)?$/i
                        );
                        if (m) {
                            year = normalizeYear(+m[1]);
                            month = parseMonth(m[2]);
                            day = +m[3];
                            if (m[4]) {
                                hour = +m[4];
                                minute = +m[5];
                                second = m[6] ? +m[6] : 0;
                                ampm = m[7]?.toLowerCase() || null;
                            }
                        }

                        // ===============================
                        // 5. MM DD YYYY [TIME]
                        // ===============================
                        if (!month) {
                            m = input.match(
                                /^(\d{1,2}|[a-zA-Z]+)[\/\-\s\\]+(\d{1,2})[\/\-\s\\]+(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(am|pm)?)?$/i
                            );
                            if (m) {
                                month = parseMonth(m[1]);
                                day = +m[2];
                                year = normalizeYear(+m[3]);
                                if (m[4]) {
                                    hour = +m[4];
                                    minute = +m[5];
                                    second = m[6] ? +m[6] : 0;
                                    ampm = m[7]?.toLowerCase() || null;
                                }
                            }
                        }

                        // ===============================
                        // 6. MM DD [TIME]
                        // ===============================
                        if (!month) {
                            m = input.match(
                                /^(\d{1,2}|[a-zA-Z]+)[\/\-\s\\]+(\d{1,2})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(am|pm)?)?$/i
                            );
                            if (m) {
                                month = parseMonth(m[1]);
                                day = +m[2];
                                if (m[3]) {
                                    hour = +m[3];
                                    minute = +m[4];
                                    second = m[5] ? +m[5] : 0;
                                    ampm = m[6]?.toLowerCase() || null;
                                }
                            }
                        }

                        if (!month || !day || day < 1 || day > 31) return null;

                        // ===============================
                        // 7. 12h  24h
                        // ===============================
                        let hour24 = hour;
                        if (ampm === "pm" && hour !== 12) hour24 += 12;
                        if (ampm === "am" && hour === 12) hour24 = 0;

                        // ===============================
                        // 8. Final result
                        // ===============================
                        return {
                            year,
                            month,
                            day,
                            hour24,
                            hour12: ((hour24 + 11) % 12) + 1,
                            minute,
                            second,
                            ampm,

                            display12h: `${((hour24 + 11) % 12) + 1}:${String(minute).padStart(2, "0")} ${hour24 >= 12 ? "PM" : "AM"}`,
                            display24h: `${String(hour24).padStart(2, "0")}:${String(minute).padStart(2, "0")}`,

                            isoLocal:
                                `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}T` +
                                `${String(hour24).padStart(2, "0")}:${String(minute).padStart(2, "0")}:${String(second).padStart(2, "0")}`,

                            isTimeOnly: false
                        };
                    }

                    // function parseDateField(inputElement) {
                    //     let value = inputElement.value.trim();
                    //     if (!value) return;
                    //     value = stripTimezone(value);
                    //     const parsed = parseCustomDateTime(value);
                    //     console.log(parsed)
                    //     if (!parsed) return handleInvalid(inputElement);
                    //     const localDateTime =
                    //         parsed.getFullYear() + "-" +
                    //         String(parsed.getMonth() + 1).padStart(2, "0") + "-" +
                    //         String(parsed.getDate()).padStart(2, "0") + "T" +
                    //         String(parsed.getHours()).padStart(2, "0") + ":" +
                    //         String(parsed.getMinutes()).padStart(2, "0") + ":" +
                    //         String(parsed.getSeconds()).padStart(2, "0");
                    //     inputElement.setAttribute("data-parsed-date", localDateTime);
                    //     const monthStr = String(parsed.getMonth() + 1).padStart(2, "0");
                    //     const dayStr = String(parsed.getDate()).padStart(2, "0");
                    //     const yearStr = parsed.getFullYear();
                    //     let displayHour = parsed.getHours();
                    //     const displayMinute = String(parsed.getMinutes()).padStart(2, "0");
                    //     const displayAMPM = displayHour >= 12 ? "PM" : "AM";
                    //     displayHour = displayHour % 12 || 12;
                    //     const displayHourStr = String(displayHour).padStart(2, "0");
                    //     inputElement.value = `${monthStr}/${dayStr}/${yearStr} ${displayHourStr}:${displayMinute} ${displayAMPM}`;
                    //     inputElement.style.borderColor = "#4CAF50";
                    //     inputElement.style.color = "#000";
                    //     const fieldDiv = inputElement.closest(".input-field");
                    //     if (fieldDiv) fieldDiv.classList.add("has-value");
                    //     setTimeout(() => (inputElement.style.borderColor = ""), 1000);
                    //     showToast(" Date parsed successfully", 2000);
                    // }

                    function parseDateField(inputElement) {
                        let value = inputElement.value.trim();
                        if (!value) return;

                        // Do NOT strip timezone separately anymore
                        const parsed = parseCustomDateTime(value);
                        console.log(parsed);

                        if (!parsed) return handleInvalid(inputElement);
                        
                        // Clear any field errors on success
                        clearFieldError(inputElement);
                        document.getElementById('bid-failure-message').classList.add('hide');
                        // Build ISO-like local datetime (timezone ignored)
                        const localDateTime =
                            parsed.year + "-" +
                            String(parsed.month).padStart(2, "0") + "-" +
                            String(parsed.day).padStart(2, "0") + "T" +
                            String(parsed.hour24).padStart(2, "0") + ":" +
                            String(parsed.minute).padStart(2, "0") + ":" +
                            String(parsed.second).padStart(2, "0");

                        inputElement.setAttribute("data-parsed-date", localDateTime);

                        // Display formatting (MM/DD/YYYY HH:MM AM/PM)
                        const monthStr = String(parsed.month).padStart(2, "0");
                        const dayStr = String(parsed.day).padStart(2, "0");
                        const yearStr = parsed.year;

                        const displayHourStr = String(parsed.hour12).padStart(2, "0");
                        const displayMinuteStr = String(parsed.minute).padStart(2, "0");
                        const displayAMPM = parsed.ampm
                            ? parsed.ampm.toUpperCase()
                            : parsed.hour24 >= 12 ? "PM" : "AM";

                        inputElement.value =
                            `${monthStr}/${dayStr}/${yearStr} ` +
                            `${displayHourStr}:${displayMinuteStr} ${displayAMPM}`;

                        // UI feedback
                        inputElement.style.borderColor = "#4CAF50";
                        inputElement.style.color = "#000";

                        const fieldDiv = inputElement.closest(".input-field");
                        if (fieldDiv) fieldDiv.classList.add("has-value");

                        setTimeout(() => (inputElement.style.borderColor = ""), 1000);
                        showToast(" Date parsed successfully", 2000);
                    }



                    // function handleInvalid(inputElement) {
                    //     inputElement.style.borderColor = "#f44336";
                    //     inputElement.style.color = "#f44336";
                    //     showToast("Invalid date.Format: MM-DD-YYYY HH:MM:SS", 3000);
                    //     throw new Error("Invalid date");
                    // }

                    function handleInvalid(inputElement) {
                        // mark input invalid via class
                        inputElement.classList.add('invalid');
                        
                        const fieldDiv = inputElement.closest('.input-field');
                        if (fieldDiv) {
                            fieldDiv.classList.add('has-error');
                            
                            // Find or create inline error element
                            let errorEl = fieldDiv.querySelector('.field-error');
                            if (!errorEl) {
                                errorEl = document.createElement('div');
                                errorEl.className = 'field-error';
                                fieldDiv.appendChild(errorEl);
                            }
                            
                            const now = new Date();
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const exampleDate = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()} 09:00 AM`;
                            errorEl.innerHTML = `<strong>Invalid date format</strong><br>Format: MMM DD, YYYY HH:MM AM/PM<br>Example: ${exampleDate}`;
                            errorEl.classList.add('show');
                        }

                        throw new Error('Invalid date');
                    }
                    
                    function clearFieldError(inputElement) {
                        inputElement.classList.remove('invalid');
                        const fieldDiv = inputElement.closest('.input-field');
                        if (fieldDiv) {
                            fieldDiv.classList.remove('has-error');
                            const errorEl = fieldDiv.querySelector('.field-error');
                            if (errorEl) {
                                errorEl.classList.remove('show');
                            }
                        }
                    }


                    input.parseDateFn = parseDateField;
                    input.addEventListener('focus', function () {
                        this.style.borderColor = '';
                        this.style.color = '';
                        clearFieldError(this);
                    });
                } else {
                    input = document.createElement('input');
                    input.type = field.type || 'text';
                    console.log(field);
                    console.log(field.attribute_number);
                    input.placeholder = ' ';
                }
                input.id = field.id;
                input.name = field.id;
                input.autocomplete = 'off';
                if (field.id == "load_id") {
                    input.value = `${window.logged_in_consumer}_${Math.floor(Date.now() * 1000 + (performance.now() % 1) * 1000)}`;
                }
                // Only add has-value if there's actual content
                if (field.default !== undefined && field.default !== null && field.default !== '' && 
                    !(Array.isArray(field.default) && field.default.length === 0)) {
                    input.value = field.default;
                    fieldDiv.classList.add('has-value');
                }
                if (field.required) input.required = true;
                let sanitizeTimer; // Declare timer for numeric sanitization
                input.addEventListener('input', function () {
                    if (field.attribute_number == true) {
                        clearTimeout(sanitizeTimer); // Clear previous timer
                        sanitizeTimer = setTimeout(() => {
                            let val = input.value;
                            // Remove all non-numeric characters except decimal point
                            val = val.replace(/[^0-9.]/g, '');
                            // Allow only one decimal point
                            const parts = val.split('.');
                            if (parts.length > 2) {
                                val = parts[0] + '.' + parts.slice(1).join('');
                            }
                            input.value = val;
                        }, 300); // Reduced from 400ms to 300ms for faster feedback
                    }
                    if (this.value) {
                        fieldDiv.classList.add('has-value');
                    } else {
                        fieldDiv.classList.remove('has-value');
                    }
                });
                inputWrapper.appendChild(input);
                const label = document.createElement('label');
                label.textContent = field.label;
                if (field.required) label.classList.add('required');
                inputWrapper.appendChild(label);
                if (isDistanceField && hasGoogleMaps) {
                    const icon = document.createElement('i');
                    icon.className = 'fa-solid fa-route input-icon';
                    icon.title = 'Fetch Distance from Google Maps';
                    icon.onclick = fetchDistanceFromGoogle;
                    inputWrapper.appendChild(icon);
                }
                if (isDateTimeField && input.parseDateFn) {
                    const parseIcon = document.createElement('i');
                    parseIcon.className = 'fa-solid fa-wand-magic-sparkles input-icon datetime-parse-icon';
                    parseIcon.title = 'Parse Date (Click to convert natural language to date)';
                    let typingTimer;
                    function handleParse(input) {
                        input.parseDateFn(input);
                    }
                    input.addEventListener("blur", function (e) {
                        handleParse(input);
                    });
                    input.addEventListener("paste", function (e) {
                        clearTimeout(typingTimer);
                        setTimeout(() => {
                            handleParse(input);
                        }, 30);
                    });
                }
                if (inputWrapper !== fieldDiv) {
                    fieldDiv.appendChild(inputWrapper);
                }
                return fieldDiv;
            }

            function collectFormData() {
                const formData = {};
                console.log(stops);
                if (stops.length >= 1) {
                    const origin = stops[0];
                    formData.origin_city = origin.city;
                    formData.origin_state = origin.state;
                    formData.origin_country = origin.country === 'US' ? 'USA' : origin.country;
                    formData.origin_postal_code = origin.zip;
                }
                if (stops.length >= 2) {
                    const destination = stops[stops.length - 1];
                    formData.destination_city = destination.city;
                    formData.destination_state = destination.state;
                    formData.destination_country = destination.country === 'US' ? 'USA' : destination.country;
                    formData.destination_postal_code = destination.zip;
                }
                formData.stops_info = stops.map(function (stop, index) {
                    const stopType = (index === 0) ? 'pickup' : 'delivery';
                    const stopInfo = {
                        city: stop.city,
                        state: stop.state,
                        country: stop.country === 'US' ? 'USA' : stop.country,
                        postal_code: stop.zip,
                        type: stopType,
                        facility_name: stop.facility_name || '',
                        live_drop: stop.type
                    };
                    if (currentAccount && currentAccount.location_modal_fields) {
                        currentAccount.location_modal_fields.forEach(function (field) {
                            if (stop[field.id] !== undefined) {
                                stopInfo[field.id] = stop[field.id];
                            }
                        });
                    }
                    return stopInfo;
                });
                const form = document.getElementById('dynamic-form');
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(function (input) {
                    if (input.type === 'hidden' && input.id.endsWith('_value')) {
                        return;
                    }
                    if (input.getAttribute("not_include") === "true") {
                        return;
                    }
                    const fieldId = input.name || input.id;
                    const apiKey = getFieldApiKey(fieldId);
                    if (input.getAttribute('data-datetime') === 'true') {
                        const parsedDate = input.getAttribute('data-parsed-date');
                        if (parsedDate) {
                            const date = new Date(parsedDate);
                            const formatted = date.getFullYear() + '-' +
                                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                                String(date.getDate()).padStart(2, '0') + ' ' +
                                String(date.getHours()).padStart(2, '0') + ':' +
                                String(date.getMinutes()).padStart(2, '0') + ':' +
                                String(date.getSeconds()).padStart(2, '0');
                            formData[apiKey] = formatted;
                        } else if (input.value) {
                            try {
                                const normalized = normalizeDateString(input.value);
                                const parsed = chrono.parseDate(normalized);
                                if (parsed) {
                                    const formatted = parsed.getFullYear() + '-' +
                                        String(parsed.getMonth() + 1).padStart(2, '0') + '-' +
                                        String(parsed.getDate()).padStart(2, '0') + ' ' +
                                        String(parsed.getHours()).padStart(2, '0') + ':' +
                                        String(parsed.getMinutes()).padStart(2, '0') + ':' +
                                        String(parsed.getSeconds()).padStart(2, '0');
                                    formData[apiKey] = formatted;
                                } else {
                                    formData[apiKey] = input.value;
                                }
                            } catch (e) {
                                formData[apiKey] = input.value;
                            }
                        }
                    } else {
                        formData[apiKey] = input.value;
                    }
                });
                const searchableSelects = form.querySelectorAll('.searchable-select-container');
                searchableSelects.forEach(function (container) {
                    const fieldId = container.getAttribute('data-field-id');
                    const apiKey = getFieldApiKey(fieldId);
                    if (container.getSelectedValues) {
                        formData[apiKey] = container.getSelectedValues();
                    }
                });
                const extraFieldsContainer = document.getElementById('form-extra-fields');
                const extraInputs = extraFieldsContainer.querySelectorAll('input, select, textarea');
                extraInputs.forEach(function (input) {
                    if (input.type === 'hidden' && input.id.endsWith('_value')) {
                        return;
                    }
                    const fieldId = input.name || input.id;
                    const apiKey = getFieldApiKey(fieldId);
                    formData[apiKey] = input.value;
                });
                const extraSearchableSelects = extraFieldsContainer.querySelectorAll('.searchable-select-container');
                extraSearchableSelects.forEach(function (container) {
                    const fieldId = container.getAttribute('data-field-id');
                    const apiKey = getFieldApiKey(fieldId);
                    if (container.getSelectedValues) {
                        formData[apiKey] = container.getSelectedValues();
                    }
                });
                if (formData.accessorials === undefined) {
                    formData.accessorials = [];
                }
                console.log('transit_related_items:', formData.transit_related_items);
                if (formData.transit_related_items === undefined || formData.transit_related_items === "") {
                    formData.transit_related_items = [];
                } else {
                    formData.transit_related_items = [formData.transit_related_items];
                }
                if (formData.cargo_value === undefined) {
                    formData.cargo_value = 0.00;
                }
                if (formData.commodity === undefined) {
                    formData.commodity = '';
                }
                if (currentAccount && currentAccount.hidden_fields) {
                    currentAccount.hidden_fields.forEach(function (field) {
                        if (field.default !== undefined) {
                            if (formData[field.id] === undefined) {
                                formData[field.id] = field.default;
                            }
                        }
                    });
                }
                return formData;
            }

            function validateAvrlPayload(payload) {
                console.log('Validating payload:', payload);
                const missing = [];
                const requiredNonEmpty = [
                    'shipper_code',
                    'load_id',
                    'pickup_date_time',
                    'delivery_date_time',
                    'equipment_type',
                    'distance_mi'
                ];
                requiredNonEmpty.forEach(key => {
                    if (
                        payload[key] === undefined ||
                        payload[key] === null ||
                        payload[key] === ''
                    ) {
                        missing.push(key);
                    }
                });
                if (payload.commodity === undefined || payload.commodity === null) {
                    missing.push('commodity');
                } else if (typeof payload.commodity !== 'string') {
                    missing.push('commodity (must be string)');
                }
                if (payload.transit_related_items === undefined) {
                    missing.push('transit_related_items');
                } else if (!Array.isArray(payload.transit_related_items)) {
                    missing.push('transit_related_items (must be array)');
                }
                if (payload.accessorials === undefined) {
                    missing.push('accessorials');
                } else if (!Array.isArray(payload.accessorials)) {
                    missing.push('accessorials (must be array)');
                }
                if (!Array.isArray(payload.stops_info) || payload.stops_info.length < 2) {
                    missing.push('stops_info (must contain at least pickup and delivery)');
                } else {
                    payload.stops_info.forEach((stop, index) => {
                        const prefix = `stops_info[${index}]`;
                        const requiredStopFields = [
                            'city',
                            'state',
                            'country',
                            'postal_code',
                            'type'
                        ];
                        requiredStopFields.forEach(field => {
                            if (
                                stop[field] === undefined ||
                                stop[field] === null ||
                                stop[field] === ''
                            ) {
                                missing.push(`${prefix}.${field}`);
                            }
                        });
                        if (stop.live_drop !== undefined &&
                            stop.live_drop !== 'live' &&
                            stop.live_drop !== 'drop') {
                            missing.push(`${prefix}.live_drop (must be 'live' or 'drop')`);
                        }
                    });
                }
                if (missing.length) {
                    throw new Error(
                        'AVRL payload validation failed. Missing / invalid fields: ' +
                        missing.join(', ')
                    );
                }
                return true;
            }

            function fetchRate(e) {
                if (e && e.preventDefault) e.preventDefault();
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'enable_paste_capture_flag',
                    message: false
                }, '*');
                const formData = collectFormData();
                try {
                    validateAvrlPayload(formData);
                } catch (error) {
                    console.error(error.message);
                    window.parent.postMessage({
                        source: 'avrl-glass-client',
                        action: 'show-error-rate-fetch',
                        message: error.message
                    }, '*');
                    return;
                }
                const failureMsg = document.getElementById('bid-failure-message');
                if (failureMsg) {
                    failureMsg.textContent = '';
                    failureMsg.classList.add('hide');
                }
                showLoading();
                
                // Fetch credentials from Chrome storage
                storageAPI.get(['glass_active_user_session_key', 'glass_active_account'], function (result) {
                    const sessionKey = result.glass_active_user_session_key || window.supergen_session_key;
                    const selectedAccount = result.glass_active_account || window.glass_selected_account;
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', 'https://glass.1avrl.com/avrls_forwarder', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    console.log("Fetched from storage - account:", selectedAccount, "sessionKey:", sessionKey ? "present" : "missing");
                    
                    if (selectedAccount) {
                        xhr.setRequestHeader('glass-selected-account', selectedAccount);
                    }
                    if (sessionKey) {
                        xhr.setRequestHeader('supergen-session-key', sessionKey);
                    }
                    
                    xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        hideLoading();
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                console.log('API Response:', response);
                                displayRates(response);
                            } catch (e) {
                                console.error('Response parse failed:', e);
                                showToast('Invalid response from server', 3000);
                            }
                            return;
                        }
                        let errorMessage = 'Request failed (Status: ' + xhr.status + ')';
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || errorResponse.error || errorMessage;
                        } catch (_) { }
                        showToast(errorMessage, 4000);
                        if (failureMsg) {
                            failureMsg.textContent = errorMessage;
                            failureMsg.classList.remove('hide');
                        }
                        if (xhr.status === 403) {
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'show-error-rate-fetch',
                                message: errorMessage
                            }, '*');
                        }
                        if (xhr.status === 401) {
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'show-error-rate-fetch',
                                message: errorMessage
                            }, '*');

                            // Send postMessage to extension to handle login and tab switching
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'open-login-page',
                                url: 'https://glass.1avrl.com/render_page_to_user'
                            }, '*');

                        }
                        [
                            'avrl-rate',
                            'base-rate',
                            'fuel-rate',
                            'dat-high',
                            'dat-rate',
                            'dat-low'
                        ].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = '$----';
                        });
                        [
                            'dat-dest',
                            'dat-origin',
                            'dat-timeframe'
                        ].forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = '';
                        });
                        document.getElementById('rate-info-icon')?.classList.add('hide');
                    }
                };
                xhr.send(JSON.stringify(formData));
                });
            }

            // Color threshold configuration for base ratio
            const RATIO_THRESHOLDS = {
                loss:       { min: -Infinity, max: 0,    class: 'ratio-loss',       color: '#e53935' },  // <0%: Red (Loss)
                low:        { min: 0,         max: 5,    class: 'ratio-low',        color: '#F9A825' },  // 0-5%: Muted Amber (Low)
                acceptable: { min: 5,         max: 10,   class: 'ratio-acceptable', color: '#61e529' },  // 5-10%: Light Green (Acceptable)
                inline:     { min: 10,        max: 15,   class: 'ratio-inline',     color: '#24ae24' },  // 10-15%: Green (In line with AVG)
                high:       { min: 15,        max: 25,   class: 'ratio-high',       color: '#137413' },  // 15-25%: Dark Green (High)
                veryhigh:   { min: 25,        max: Infinity, class: 'ratio-veryhigh',   color: '#1B5E20' }   // >25%: Dark Forest Green (Very High)
            };

            /**
             * Calculate and display base ratio (how much higher bid_submitted is vs base_rate)
             * @param {number} bidSubmitted - The bid submitted amount
             * @param {number} baseRate - The base rate amount
             */
            function updateBaseRatio(bidSubmitted, baseRate) {
                const ratioElement = document.getElementById('base-ratio');
                
                if (!ratioElement) return;
                
                // Reset if invalid values
                if (!bidSubmitted || !baseRate || baseRate === 0) {
                    ratioElement.textContent = '--';
                    ratioElement.className = 'num rate-ratio';
                    return;
                }
                
                // Calculate percentage difference (how much higher/lower)
                const percentDiff = ((bidSubmitted - baseRate) / baseRate) * 100;
                const percentDiffFormatted = percentDiff.toFixed(1);
                const displayText = percentDiff >= 0 ? `+${percentDiffFormatted}%` : `${percentDiffFormatted}%`;
                
                // Determine color class based on thresholds (use actual value, not absolute)
                let colorClass = 'ratio-veryhigh';
                let thresholdColor = '#ff9800';
                
                for (const [key, threshold] of Object.entries(RATIO_THRESHOLDS)) {
                    if (percentDiff >= threshold.min && percentDiff < threshold.max) {
                        colorClass = threshold.class;
                        thresholdColor = threshold.color;
                        break;
                    }
                }
                
                // Update element with inline color
                ratioElement.textContent = displayText;
                ratioElement.className = `num rate-ratio ${colorClass}`;
                ratioElement.style.color = thresholdColor;
            }

            function getBidType(logText) {
                if (!logText || typeof logText !== "string") return null;
                const lineHaulMatches = [...logText.matchAll(/\bbrppamfsc\b/gi)];
                const allInMatches = [...logText.matchAll(/\bbrppa\b(?!mfsc)/gi)];
                const idxLineHaul =
                    lineHaulMatches.length > 0
                        ? lineHaulMatches[lineHaulMatches.length - 1].index
                        : -1;
                const idxAllIn =
                    allInMatches.length > 0
                        ? allInMatches[allInMatches.length - 1].index
                        : -1;
                if (idxLineHaul === -1 && idxAllIn === -1) return null;
                if (idxLineHaul > idxAllIn) return "LineHaul";
                return "All-In";
            }

            function displayRates(response) {
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'enable_paste_capture_flag',
                    message: true
                }, '*');
                console.log('Displaying rates from response:', response);
                const graphContainer = document.getElementById('rate-graph-mini');
                if (graphContainer) {
                    graphContainer.classList.remove('show');
                    graphContainer.style.display = 'none';
                    graphContainer.style.opacity = '0';
                }
                const miniBar = document.getElementById('mini-range-bar');
                if (miniBar) {
                    miniBar.innerHTML = '';
                }
                if (response.code === 'rating_ok' && response.additional_data) {
                    const failureMsg = document.getElementById('bid-failure-message');
                    failureMsg.textContent = '';
                    failureMsg.classList.add('hide');
                    const additionalData = response.additional_data;
                    const respPkt = additionalData.resp_pkt || {};
                    const paData = parsePremiumAugments(response);
                    console.log('Parsed Premium Augments:', paData);
                    var bid_type = getBidType(additionalData["reasons_str"])
                    let baseRate = additionalData.base_rate;
                    const fuelSurcharge = additionalData.fuel_surcharge || 0;
                    const recommendedRate = additionalData.bid_submitted || response.data.rate;
                    global_recommended_rate = recommendedRate
                    if (recommendedRate) {
                        document.getElementById('avrl-rate').textContent = '$' + recommendedRate.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        document.getElementById("avrl_rate_type").textContent = `[ ${bid_type} ]`;
                    }
                    if (baseRate) {
                        document.getElementById('base-rate').textContent = '$' + baseRate.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (fuelSurcharge) {
                        document.getElementById('fuel-rate').textContent = '$' + fuelSurcharge.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    
                    // Update base ratio (bid_submitted / base_rate)
                    updateBaseRatio(recommendedRate, baseRate);
                    if (respPkt['dat.rateview.high_all_in_rate']) {
                        document.getElementById('dat-high').textContent = '$' + respPkt['dat.rateview.high_all_in_rate'].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (respPkt['dat.rateview.avg_all_in_rate']) {
                        document.getElementById('dat-rate').textContent = '$' + respPkt['dat.rateview.avg_all_in_rate'].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (respPkt['dat.rateview.low_all_in_rate']) {
                        document.getElementById('dat-low').textContent = '$' + respPkt['dat.rateview.low_all_in_rate'].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (respPkt['dat.rateview.escalation.origin.name']) {
                        document.getElementById('dat-origin-name').textContent = respPkt['dat.rateview.escalation.origin.name']
                    }
                    if (respPkt['dat.rateview.escalation.destination.name']) {
                        document.getElementById('dat-dest-name').textContent = respPkt['dat.rateview.escalation.destination.name']
                    }
                    if (respPkt['dat.rateview.escalation.origin.type']) {
                        document.getElementById('dat-origin').textContent = `[${respPkt['dat.rateview.escalation.origin.type']}]`
                        document.querySelector(".geo-box").classList.remove("hide");
                    }
                    if (respPkt['dat.rateview.escalation.destination.type']) {
                        document.getElementById('dat-dest').textContent = `[${respPkt['dat.rateview.escalation.destination.type']}]`
                    }
                    if (respPkt['dat.rateview.escalation.timeframe']) {
                        document.getElementById('dat-timeframe').textContent = `${respPkt['dat.rateview.escalation.timeframe']} days`;
                    }
                    const graphData = {
                        avrlRate: recommendedRate || 0,
                        baseRate: baseRate || 0,
                        paTotal: paData.totalPA || 0,
                        base_rate_transformation: paData.baseRateTransformations,
                        premiums: paData.premiums || [],
                        datHigh: respPkt['dat.rateview.high_all_in_rate'] || 0,
                        datRate: respPkt['dat.rateview.avg_all_in_rate'] || 0,
                        datLow: respPkt['dat.rateview.low_all_in_rate'] || 0,
                        datoriginname: respPkt['dat.rateview.escalation.origin.name'],
                        datdesname: respPkt['dat.rateview.escalation.destination.name'],
                        datorigin: `[${respPkt['dat.rateview.escalation.origin.type']}]`,
                        datdestination: `[${respPkt['dat.rateview.escalation.origin.type']}]`,
                        dattimeframe: `${respPkt['dat.rateview.escalation.timeframe']} days`,
                        bid_type: bid_type,
                        fuel_rate: document.getElementById('fuel-rate').textContent,
                        reason_str: additionalData.reasons_str

                    };
                    console.log("graph data", graphData)
                    rateGraph.updateGraph(graphData);
                    if (additionalData.reasons_str) {
                        const reasonsSplit = additionalData.reasons_str
                            .split("//Processing lb_nonspecific_general_pa_greenbush//;")
                            .splice(0, 1)[0]
                            .split(";");
                        reasonsSplit.splice(0, 1);
                        console.log("reasonsSplit", reasonsSplit)
                        const reasonsList = document.getElementById('rate-reasons-list');
                        reasonsList.innerHTML = '';
                        if (paData.premiums.length > 0) {
                            const premiumHeader = document.createElement('li');
                            premiumHeader.innerHTML = 'Premium Augments Applied:';
                            // premiumHeader.style.marginTop = '10px';
                            // premiumHeader.style.color = '#03363d';
                            premiumHeader.classList.add("num")
                            reasonsList.appendChild(premiumHeader);
                            const premium_list = document.createElement("ul")
                            paData.premiums.forEach(function (premium) {
                                const li = document.createElement('li');
                                li.classList.add("num")
                                li.textContent = premium.code + ': ' + premium.description + ' (' + premium.amount + ')';
                                li.style.marginLeft = '15px';
                                premium_list.appendChild(li);
                            });
                            if (paData.totalPA > 0) {
                                const totalLi = document.createElement('li');
                                totalLi.classList.add("num")
                                totalLi.innerHTML = '<strong>Total PA: $' + paData.totalPA.toFixed(2) + '</strong>';
                                totalLi.style.marginLeft = '15px';
                                totalLi.style.color = '#4caf50';
                                premium_list.appendChild(totalLi);
                            }
                            premiumHeader.appendChild(premium_list)
                        }
                        reasonsSplit.forEach(function (reason) {
                            if (reason &&
                                !reason.includes('Setting the BidSub mechanism on the next tree') &&
                                !reason.includes('Bid Submitted (-1)') &&
                                reason.trim() !== '') {
                                const li = document.createElement('li');
                                li.classList.add("num")
                                li.textContent = reason.trim();
                                reasonsList.appendChild(li);
                            }
                        });

                        if (reasonsList.children.length > 0) {
                            document.getElementById('rate-info-icon').classList.remove('hide');
                        } else {
                            document.getElementById('rate-info-icon').classList.add('hide');
                        }
                    } else {
                        document.getElementById('rate-info-icon').classList.add('hide');
                    }


                    console.log('Rates displayed successfully');
                    initRateSliders({
                        base: baseRate,
                        bidSub: recommendedRate,
                        premium: paData.totalPA,
                    });
                    console.log("rrrrrrrrrrrrrrrr")
                } else if (response.code === 'decline_bid') {
                    console.log('Bid declined:', response.message);
                    const failureMsg = document.getElementById('bid-failure-message');
                    failureMsg.textContent = response.message || 'The carrier declines to bid on this load';
                    failureMsg.classList.remove('hide');
                    showToast('Bid declined: ' + response.message, 4000);
                    document.getElementById('avrl-rate').textContent = '$----';
                    document.getElementById('base-rate').textContent = '$----';
                    document.getElementById('base-ratio').textContent = '--';
                    document.getElementById('base-ratio').className = 'num rate-ratio';
                    document.getElementById('fuel-rate').textContent = '$----';
                    document.getElementById('dat-high').textContent = '$----';
                    document.getElementById('dat-rate').textContent = '$----';
                    document.getElementById('dat-low').textContent = '$----';
                    document.getElementById('dat-dest').textContent = '----';
                    document.getElementById('dat-origin').textContent = '----';
                    document.getElementById('dat-timeframe').textContent = '----';
                    document.querySelector(".geo-box").classList.add("hide");
                    document.getElementById('rate-info-icon').classList.add('hide');
                } else if (response.status === 'failed' || response.status === 'error') {
                    console.error('Rate fetch failed:', response);
                    const failureMsg = document.getElementById('bid-failure-message');
                    failureMsg.textContent = response.message || 'Failed to fetch rate';
                    failureMsg.classList.remove('hide');
                    showToast('Error: ' + (response.message || 'Failed to fetch rate'), 4000);
                    document.getElementById('avrl-rate').textContent = '$----';
                    document.getElementById('base-rate').textContent = '$----';
                    document.getElementById('base-ratio').textContent = '--';
                    document.getElementById('base-ratio').className = 'num rate-ratio';
                    document.getElementById('fuel-rate').textContent = '$----';
                    document.getElementById('dat-high').textContent = '$----';
                    document.getElementById('dat-rate').textContent = '$----';
                    document.getElementById('dat-low').textContent = '$----';
                    document.getElementById('dat-dest').textContent = '----';
                    document.getElementById('dat-origin').textContent = '----';
                    document.getElementById('dat-timeframe').textContent = '----';
                    document.getElementById('rate-info-icon').classList.add('hide');
                    document.querySelector(".geo-box").classList.add("hide");
                } else {
                    console.warn('Unknown response format, attempting to display available data');
                    const data = response.data || {};
                    const additionalData = response.additional_data || {};
                    const bidSubmitted = data.rate || additionalData.bid_submitted;
                    if (bidSubmitted) {
                        document.getElementById('avrl-rate').textContent = '$' + bidSubmitted.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (additionalData.base_rate) {
                        document.getElementById('base-rate').textContent = '$' + additionalData.base_rate.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    if (additionalData.fuel_surcharge) {
                        document.getElementById('fuel-rate').textContent = '$' + additionalData.fuel_surcharge.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    }
                    // Update base ratio
                    updateBaseRatio(bidSubmitted, additionalData.base_rate);
                    document.getElementById('rate-info-icon').classList.add('hide');
                }
            }

            function resetForm() {
                if (currentAccount) {
                    document.getElementById("avrl_rate_type").textContent = "";
                    document.getElementById("rate-sliders").style.display = "none";
                    const failureMsg = document.getElementById('bid-failure-message');
                    if (failureMsg) {
                        failureMsg.textContent = '';
                        failureMsg.classList.add('hide');
                    }
                    document.getElementById('avrl-rate').textContent = '$----';
                    document.getElementById('base-rate').textContent = '$----';
                    document.getElementById('base-ratio').textContent = '--';
                    document.getElementById('base-ratio').className = 'num rate-ratio';
                    document.getElementById('fuel-rate').textContent = '$----';
                    document.getElementById('dat-high').textContent = '$----';
                    document.getElementById('dat-rate').textContent = '$----';
                    document.getElementById('dat-low').textContent = '$----';
                    document.getElementById('dat-dest').textContent = '----';
                    document.getElementById('dat-origin').textContent = '----';
                    document.getElementById('dat-timeframe').textContent = '----';
                    document.getElementById('rate-info-icon').classList.add('hide');
                    document.querySelector(".geo-box").classList.add("hide");
                    const graphContainer = document.getElementById('rate-graph-mini');
                    if (graphContainer) {
                        graphContainer.classList.remove('show');
                        graphContainer.style.display = 'none';
                        graphContainer.style.opacity = '0';
                    }
                    const miniBar = document.getElementById('mini-range-bar');
                    if (miniBar) {
                        miniBar.innerHTML = '';
                    }
                    const reasonsList = document.getElementById('rate-reasons-list');
                    if (reasonsList) {
                        reasonsList.innerHTML = '';
                    }
                    stops = [
                        { city: '', state: '', zip: '', country: 'US', type: 'live', label: 'Origin' },
                        { city: '', state: '', zip: '', country: 'US', type: 'live', label: 'Destination' }
                    ];
                    renderForm(currentAccount);
                }
            }

            function init() {
                storageAPI.get("glass_active_account", function (r) {
                    console.log("resss", JSON.stringify(r))
                })
                window.addEventListener('message', function (event) {
                    console.log('[master.html] Received postMessage:', event.data);
                    if (event.data && event.data.source === 'avrl-glass-bridge') {
                        console.log('[master.html] Message from avrl-glass-bridge, action:', event.data.action);
                        if (event.data.action === 'config.loaded') {
                            const receivedConfig = event.data.config;
                            config = receivedConfig;
                            config["accounts"].push(dynamic_config);
                            // Initialize features if not present
                            if (!config.features) {
                                config.features = {};
                            }
                            if (config.features.multi_stops === undefined) {
                                config.features.multi_stops = true;
                            }
                            console.log('[master.html] Processed config:', config);
                            document.getElementById('client-name-display').textContent = `${config.glass_active_user} `;
                            document.getElementById('account-name-display').textContent = `${config.display_account_name}`;
                            window.supergen_session_key = config.glass_active_user_session_key;
                            window.glass_selected_account = config.display_account_name;
                            renderAccountSelector();
                            hideLoading();
                        } else if (event.data.action == "storage.get.response") {
                            if (event.data.data.glass_active_user) {
                                window.logged_in_consumer = event.data.data.glass_active_user;
                            }
                        } else if (event.data.action === 'glass-mode') {
                            console.log('[master.html] Glass mode action received, enabled:', event.data.enabled);
                            if (event.data.enabled) {
                                document.body.classList.add('glass-mode');
                                document.documentElement.classList.add('glass-mode');
                                const container = document.getElementById('avrl-glass-container');
                                if (container) {
                                    const currentStyle = container.getAttribute('style') || '';
                                    const glassStyle = 'transition: none !important; background: transparent !important; background-color: rgba(0,0,0,0) !important; background-image: none !important; backdrop-filter: none !important; -webkit-backdrop-filter: none !important;';
                                    container.setAttribute('style', glassStyle + ' ' + currentStyle);
                                    console.log('[master.html] Container style set to:', container.getAttribute('style'));
                                }
                            } else {
                                document.body.classList.remove('glass-mode');
                                document.documentElement.classList.remove('glass-mode');
                                const container = document.getElementById('avrl-glass-container');
                                if (container) {
                                    container.removeAttribute('style');
                                }
                            }
                        }
                    }
                });
                document.getElementById('fetch-rate-btn').addEventListener('click', function (e) {
                    e.preventDefault();
                    document.getElementById("rate-sliders").style.display = "none";
                    fetchRate(e);
                });
                document.getElementById('reset-btn').addEventListener('click', resetForm);
                document.getElementById('avrl-rate').addEventListener('click', function () {
                    const rateText = this.textContent.trim();
                    if (rateText && rateText !== '$----') {
                        const cleanRate = rateText.replace(/[$,]/g, '');
                        function copyToClipboard(text) {
                            return new Promise(function (resolve, reject) {
                                const textarea = document.createElement('textarea');
                                textarea.value = text;
                                textarea.style.position = 'fixed';
                                textarea.style.top = '0';
                                textarea.style.left = '0';
                                textarea.style.width = '2em';
                                textarea.style.height = '2em';
                                textarea.style.padding = '0';
                                textarea.style.border = 'none';
                                textarea.style.outline = 'none';
                                textarea.style.boxShadow = 'none';
                                textarea.style.background = 'transparent';
                                textarea.style.opacity = '0';
                                document.body.appendChild(textarea);
                                textarea.focus();
                                textarea.select();
                                try {
                                    const successful = document.execCommand('copy');
                                    document.body.removeChild(textarea);
                                    if (successful) {
                                        resolve();
                                    } else {
                                        reject(new Error('execCommand failed'));
                                    }
                                } catch (err) {
                                    document.body.removeChild(textarea);
                                    reject(err);
                                }
                            });
                        }
                        copyToClipboard(cleanRate).then(function () {
                            const rateElement = document.getElementById('avrl-rate');
                            rateElement.classList.add('copied');
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'show-toast',
                                message: 'Rate copied: ' + cleanRate,
                                type: 'success'
                            }, '*');
                            setTimeout(function () {
                                rateElement.classList.remove('copied');
                            }, 1000);
                        }).catch(function (err) {
                            console.error('Failed to copy rate:', err);
                            window.parent.postMessage({
                                source: 'avrl-glass-client',
                                action: 'show-toast',
                                message: 'Failed to copy rate',
                                type: 'error'
                            }, '*');
                        });
                    }
                });
                const rateInfoIcon = document.getElementById('rate-info-icon');
                const rateTooltip = document.getElementById('rate-breakdown-tooltip');
                rateInfoIcon.addEventListener('mouseenter', function () {
                    rateTooltip.classList.remove('hide');
                });
                rateInfoIcon.addEventListener('mouseleave', function () {
                    setTimeout(function () {
                        if (!rateTooltip.matches(':hover') && !rateInfoIcon.matches(':hover')) {
                            rateTooltip.classList.add('hide');
                        }
                    }, 100);
                });
                rateTooltip.addEventListener('mouseenter', function () {
                    this.classList.remove('hide');
                });
                rateTooltip.addEventListener('mouseleave', function () {
                    this.classList.add('hide');
                });
                storageAPI.get(['glass_active_user_session_key', 'glass_active_account', 'glass_active_user'], function (result) {
                    if (!result || !result.glass_active_user_session_key || !result.glass_active_account) {
                    } else {
                        window.parent.postMessage({
                            source: 'avrl-glass-client',
                            action: 'request.config'
                        }, '*');
                    }
                });
            }

            return {
                init: init,
                editLocation: editLocation,
                closeLocationModal: closeLocationModal,
                saveLocation: saveLocation,
                fetchFromZip: fetchFromZip,
                toggleExtraFields: toggleExtraFields,
                toggleFormExtraFields: toggleFormExtraFields
            };
        })();

        window.onload = function () {
            console.log('='.repeat(60));
            console.log(' AVRL Glass Master HTML');
            console.log(' Version: 2.3.8 (Fix: Retry Only on 401, Not Other Errors)');
            console.log(' Build Date:', new Date().toISOString());
            console.log('='.repeat(60));

            document.getElementById("client-name-display").addEventListener("click", function () {
                if (document.getElementById("client-name-display").textContent.includes("@avrl.io")) {
                    window.open(
                        "https://storage.googleapis.com/avrlgeneration_static_assets_staging/html_template/rxo_mock_template.html"
                    );
                }
            });
            app.init();
            let walkthroughActive = false;
            let walkthroughFields = [];
            let walkthroughCurrentIndex = 0;
            let walkthroughBadge = null;
            document.getElementById('home-btn').addEventListener('click', function () {
                console.log('Home button clicked');
                window.open('https://glass.1avrl.com/render_page_to_user', '_blank');
            })

            function getAllEmptyFields() {
                const fields = [];
                const seenFields = new Set();
                const showMoreToggle = document.getElementById('form-show-more-toggle');
                const extraFieldsContainer = document.getElementById('form-extra-fields');
                if (showMoreToggle && extraFieldsContainer && extraFieldsContainer.classList.contains('hide')) {
                    showMoreToggle.click();
                }
                const inputs = document.querySelectorAll('#form-container input:not([type="checkbox"]), #form-container select');
                const stopInputs = document.querySelectorAll('#stops-container input:not([type="checkbox"])');
                const allFields = [...stopInputs, ...inputs];
                allFields.forEach(field => {
                    if (seenFields.has(field)) {
                        return;
                    }
                    const hasValue = field.value && field.value.trim() !== '';
                    const isVisible = field.offsetParent !== null;
                    const isDisabled = field.disabled || field.readOnly;
                    if (!hasValue && isVisible && !isDisabled) {
                        fields.push(field);
                        seenFields.add(field);
                    }
                });
                return fields;
            }

            function startWalkthrough() {
                if (walkthroughActive) {
                    stopWalkthrough();
                    return;
                }
                walkthroughFields = getAllEmptyFields();
                if (walkthroughFields.length === 0) {
                    showToast('No empty fields found!', 2000);
                    return;
                }
                walkthroughActive = true;
                walkthroughCurrentIndex = 0;
                walkthroughBadge = document.createElement('div');
                walkthroughBadge.className = 'walkthrough-badge';
                walkthroughBadge.innerHTML = `
                    <div><strong> Walkthrough Mode</strong></div>
                    <div class="walkthrough-instructions">Select text  <kbd>Enter</kbd></div>
                    <div class="walkthrough-instructions">Or type manually  <kbd>Enter</kbd></div>
                    <div class="walkthrough-instructions"><kbd>Esc</kbd> to exit</div>
                `;
                document.body.appendChild(walkthroughBadge);
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'walkthrough-state',
                    active: true
                }, '*');
                highlightCurrentField();
                showToast('Walkthrough started - ' + walkthroughFields.length + ' empty fields', 2000);
            }

            function stopWalkthrough() {
                walkthroughActive = false;
                walkthroughFields.forEach(field => {
                    field.classList.remove('walkthrough-highlight');
                    field.removeEventListener('keydown', handleFieldEnter);
                });
                if (walkthroughBadge && walkthroughBadge.parentNode) {
                    walkthroughBadge.parentNode.removeChild(walkthroughBadge);
                    walkthroughBadge = null;
                }
                walkthroughFields = [];
                walkthroughCurrentIndex = 0;
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'walkthrough-state',
                    active: false
                }, '*');
                showToast('Walkthrough ended', 2000);
            }

            function highlightCurrentField() {
                walkthroughFields.forEach(field => field.classList.remove('walkthrough-highlight'));
                if (walkthroughCurrentIndex < walkthroughFields.length) {
                    const currentField = walkthroughFields[walkthroughCurrentIndex];
                    currentField.classList.add('walkthrough-highlight');
                    currentField.addEventListener('keydown', handleFieldEnter);
                    currentField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    showToast('All fields completed!', 2000);
                    stopWalkthrough();
                }
            }

            function handleFieldEnter(e) {
                if (e.key === 'Enter' && walkthroughActive) {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentField = walkthroughFields[walkthroughCurrentIndex];
                    currentField.removeEventListener('keydown', handleFieldEnter);
                    if (currentField.id && currentField.id.startsWith('stop-zip-') && currentField.value.trim()) {
                        const stopIndex = parseInt(currentField.id.replace('stop-zip-', ''));
                        if (!isNaN(stopIndex) && typeof stops !== 'undefined' && stops[stopIndex]) {
                            const stop = stops[stopIndex];
                            const isFetching = currentField._isFetching || stop._isFetching;
                            const hasLocationData = stop && stop.city && stop.state;
                            if (hasLocationData) {
                                setTimeout(() => {
                                    moveToNextField();
                                }, 100);
                            } else if (isFetching) {
                                showToast('Fetching location in background...', 800);
                                setTimeout(() => {
                                    moveToNextField();
                                }, 500);
                            } else {
                                showToast('Fetching location...', 800);
                                window.fetchStopFromZip(stopIndex, function (success) { });
                                setTimeout(() => {
                                    moveToNextField();
                                }, 500);
                            }
                            return;
                        }
                    }
                    if (!currentField.value.trim()) {
                        showToast('Field skipped', 1000);
                    } else {
                        showToast('Field filled', 1000);
                    }
                    setTimeout(() => {
                        moveToNextField();
                    }, 500);
                }
            }

            function moveToNextField() {
                walkthroughCurrentIndex++;
                if (walkthroughCurrentIndex < walkthroughFields.length) {
                    highlightCurrentField();
                } else {
                    showToast('All fields completed!', 2000);
                    stopWalkthrough();
                }
            }

            function fillCurrentField(text) {
                if (!walkthroughActive || walkthroughCurrentIndex >= walkthroughFields.length) {
                    return;
                }
                const currentField = walkthroughFields[walkthroughCurrentIndex];
                currentField.value = text;
                const event = new Event('input', { bubbles: true });
                currentField.dispatchEvent(event);
                const inputField = currentField.closest('.input-field');
                if (inputField && text) {
                    inputField.classList.add('has-value');
                }
                window.parent.postMessage({
                    source: 'avrl-glass-client',
                    action: 'clear-selection'
                }, '*');
                if (currentField.id && currentField.id.startsWith('stop-zip-')) {
                    const stopIndex = parseInt(currentField.id.replace('stop-zip-', ''));
                    if (!isNaN(stopIndex) && typeof stops !== 'undefined' && stops[stopIndex]) {
                        const stop = stops[stopIndex];
                        const isFetching = currentField._isFetching || stop._isFetching;
                        const hasLocationData = stop && stop.city && stop.state;
                        if (hasLocationData) {
                            setTimeout(() => {
                                moveToNextField();
                            }, 100);
                        } else if (isFetching) {
                            showToast('Fetching location in background...', 800);
                            setTimeout(() => {
                                moveToNextField();
                            }, 500);
                        } else {
                            showToast('Fetching location...', 800);
                            window.fetchStopFromZip(stopIndex, function (success) { });
                            setTimeout(() => {
                                moveToNextField();
                            }, 500);
                        }
                        return;
                    }
                } else {
                    showToast('Field filled', 1000);
                }
                setTimeout(() => {
                    moveToNextField();
                }, 500);
            }

            document.addEventListener('keydown', function (e) {
                if (e.altKey && !e.shiftKey && !e.ctrlKey) {
                    if (e.key.toLowerCase() === 't') {
                        window.parent.postMessage({
                            source: 'avrl-glass-client',
                            action: 'keyboard-shortcut',
                            key: 't',
                            altKey: true
                        }, '*');
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    } else if (e.key.toLowerCase() === 'g') {
                        window.parent.postMessage({
                            source: 'avrl-glass-client',
                            action: 'keyboard-shortcut',
                            key: 'g',
                            altKey: true
                        }, '*');
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    } else if (e.key.toLowerCase() === 'w') {
                        startWalkthrough();
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                }
                if (e.key === 'Escape' && walkthroughActive) {
                    stopWalkthrough();
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                if (e.key === 'Enter' && walkthroughActive && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                    window.parent.postMessage({
                        source: 'avrl-glass-client',
                        action: 'get-selected-text'
                    }, '*');
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            }, true);

            window.addEventListener('message', function (event) {
                if (event.data && event.data.source === 'avrl-glass-bridge') {
                    if (event.data.action === 'selected-text-response') {
                        if (walkthroughActive && event.data.text) {
                            fillCurrentField(event.data.text);
                        } else if (walkthroughActive && !event.data.text) {
                            showToast('No text selected on page', 2000);
                        }
                    } else if (event.data.action === 'toggle-walkthrough') {
                        startWalkthrough();
                    } else if (event.data.action === 'walkthrough-fill') {
                        if (walkthroughActive) {
                            if (event.data.text) {
                                fillCurrentField(event.data.text);
                            } else {
                                showToast('Field skipped', 1000);
                                moveToNextField();
                            }
                        }
                    } else if (event.data.action === 'walkthrough-stop') {
                        if (walkthroughActive) {
                            stopWalkthrough();
                        }
                    }
                }
            });
        };
    </script>



</body>

</html>